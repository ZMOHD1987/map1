<!DOCTYPE html>
<html lang='ar' dir='rtl'>
<head>
    <meta charset='utf-8'>
    <title>Sharjah Municipality Food Control Section Map</title>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <link rel='stylesheet' href='https://unpkg.com/leaflet@1.7.1/dist/leaflet.css' />
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css' />
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; }
        #controls, #info { position: absolute; z-index: 400; background-color: rgba(255, 255, 255, 0.8); border-radius: 5px; padding: 10px; box-shadow: 0 0 5px rgba(0, 0, 0, 0.1); font-size: 14px; }
        #controls { top: 10px; left: 10px; width: 200px; }
        #info { top: 10px; right: 10px; width: 200px; }
        h3 { color: #388e3c; font-size: 16px; margin: 0 0 5px 0; }
        label { display: block; margin-bottom: 5px; }
        input[type='checkbox'] { margin-right: 5px; }
        input[type='text'] { width: 100%; padding: 5px; margin-bottom: 10px; border-radius: 3px; border: 1px solid #ccc; }
        button { background-color: #388e3c; color: white; border: none; padding: 7px; border-radius: 3px; cursor: pointer; font-size: 14px; margin-bottom: 5px; }
        button i { margin-right: 5px; }
        button:hover { background-color: #2e7d32; }
        .custom-popup { font-size: 14px; }
        .hidden { display: none; }
        @media (max-width: 768px) {
            #controls, #info { width: 150px; font-size: 12px; }
            button { font-size: 12px; padding: 5px; }
            #map { height: calc(100vh - 50px); }
        }
        @media (max-width: 480px) {
            #controls, #info { width: 120px; font-size: 10px; }
            button { font-size: 10px; padding: 4px; }
            #map { height: calc(100vh - 70px); }
        }
    </style>
    <script src='https://unpkg.com/leaflet@1.7.1/dist/leaflet.js'></script>
    <script src='https://code.jquery.com/jquery-3.6.0.min.js'></script>
</head>
<body>
    <div id='map'></div>
    <div id='controls'>
        <input type='text' id='search-lic' placeholder='Searsh'>
        <button onclick="toggleVisibility('action-filters')"><i class='fas fa-filter'></i> الإجراء</button>
        <div id='action-filters' class='hidden'>
            <label><input type='checkbox' class='action-filter' value='انذار'> انذار</label>
            <label><input type='checkbox' class='action-filter' value='مخالفة'> مخالفة</label>
            <label><input type='checkbox' class='action-filter' value='عينات'> عينات</label>
            <label><input type='checkbox' class='action-filter' value='متابعة'> متابعة</label>
            <label><input type='checkbox' class='action-filter' value='مغلق'> مغلق</label>
            <label><input type='checkbox' class='action-filter' value='تقرير'> تقرير</label>
            <label><input type='checkbox' class='action-filter' value='مناسب'> مناسب</label>
        </div>
        <button onclick="toggleVisibility('sector-filters')"><i class='fas fa-layer-group'></i> القطاع</button>
        <div id='sector-filters' class='hidden'>
            <label><input type='checkbox' class='sector-filter' value='1'> القطاع 1</label>
            <label><input type='checkbox' class='sector-filter' value='2'> القطاع 2</label>
            <label><input type='checkbox' class='sector-filter' value='3'> القطاع 3</label>
            <label><input type='checkbox' class='sector-filter' value='4'> القطاع 4</label>
            <label><input type='checkbox' class='sector-filter' value='5'> القطاع 5</label>
            <label><input type='checkbox' class='sector-filter' value='6'> القطاع 6</label>
            <label><input type='checkbox' class='sector-filter' value='7'> مراكز التسوق والمناطق السياحية 7</label>
            <label><input type='checkbox' class='sector-filter' value='8'> لمنشآت الصناعية 8</label>
            <label><input type='checkbox' class='sector-filter' value='9'> رخصة اعتماد 9</label>
            <label><input type='checkbox' class='sector-filter' value='10'> المقاصف المدرسية 10</label>
            <label><input type='checkbox' class='sector-filter' value='11'> المزارع 11</label>
        </div>
        <button onclick='filterPoints()'><i class='fas fa-check'></i> تطبيق الفلاتر</button>
        <hr>
        <label>من تاريخ:</label>
        <input type='date' id='date-from'>
        <label>إلى تاريخ:</label>
        <input type='date' id='date-to'>
        <div id='totals'></div>
    </div>
    <div id='info'>
        <h3>معلومات النقطة</h3>
        <div><strong>الاسم: </strong><span id='info-name'></span></div>
        <div><strong>العلامة التجارية: </strong><span id='info-BrandName'></span></div>
        <div><strong>رقم الرخصة: </strong><span id='info-lic'></span></div>
        <div><strong>المنطقة: </strong><span id='info-area'></span></div>
        <div><strong>المنطقةالفرعية: </strong><span id='info-subarea'></span></div>
        <div><strong>القطاع الجغرافي: </strong><span id='info-sector'></span></div>
        <div><strong>الموقع التفصيلي: </strong><span id='info-AREA2'></span></div>
        <div><strong>الوحدة الفرعية: </strong><span id='info-subunit'></span></div>
        <div><strong>حالة المنشأة: </strong><span id='info-FacilityStatus'></span></div>
        <div><strong>تاريخ آخر زيارة: </strong><span id='info-Fdate'></span></div>
        <div><strong>الإجراء: </strong><span id='info-action'></span></div>
        <div><strong>الإحداثيات: </strong><span id='info-coordinates'></span></div>

    <!-- زر إرسال البيانات عبر WhatsApp كأيقونة -->
    <button onclick="sendWhatsApp()" style="background:none; border:none; cursor:pointer;">
        <i class="fab fa-whatsapp fa-2x" style="color: #25D366;"></i>
    </button>
    
    <!-- زر إرسال البيانات عبر البريد الإلكتروني كأيقونة -->
    <button onclick="sendEmail()" style="background:none; border:none; cursor:pointer;">
        <i class="fas fa-envelope fa-2x" style="color: #0072C6;"></i>

 
</div>
<script>
// الدالة لإرسال البيانات عبر واتساب
function sendWhatsApp() {
    const name = document.getElementById('info-name').textContent;
    const brandName = document.getElementById('info-BrandName').textContent;
    const lic = document.getElementById('info-lic').textContent;
    const area = document.getElementById('info-area').textContent;
   const subarea = document.getElementById('info-subarea').textContent;
    const sector = document.getElementById('info-sector').textContent;
    const AREA2 = document.getElementById('info-AREA2').textContent;
    const status = document.getElementById('info-FacilityStatus').textContent;
    const Fdate= document.getElementById('info-Fdate').textContent;
    const action = document.getElementById('info-action').textContent;



    // الحصول على الإحداثيات والتأكد من إزالة أي مسافات إضافية
    let coordinates = document.getElementById('info-coordinates').textContent.trim();
    coordinates = coordinates.replace(/\s*,\s*/g, ","); // إزالة المسافات حول الفاصلة

    // رابط خرائط جوجل
    const googleMapsLink = `https://www.google.com/maps?q=${coordinates}`;

    // الرسالة المرسلة عبر واتساب
    const message = `معلومات النقطة:
الاسم: ${name}
العلامة التجارية: ${brandName}
رقم الرخصة: ${lic}
المنطقة: ${area}
المنطقة الفرعية: ${subarea}
القطاع الجغرافي: ${sector}
الوصف التفصيلي: ${AREA2}
حالة المنشأة: ${status}
تاريخ آخر زيارة: ${Fdate}
الإجراء: ${action}
الإحداثيات: ${coordinates}
رابط الموقع على خرائط جوجل: ${googleMapsLink}`;

    // فتح رابط واتساب
    const whatsappURL = `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(whatsappURL, '_blank');
}

// الدالة لإرسال البيانات عبر البريد الإلكتروني
function sendEmail() {
    const name = document.getElementById('info-name').textContent;
    const brandName = document.getElementById('info-BrandName').textContent;
    const lic = document.getElementById('info-lic').textContent;
    const area = document.getElementById('info-area').textContent;
    const subarea = document.getElementById('info-subarea').textContent;
    const sector = document.getElementById('info-sector').textContent;
    const AREA2 = document.getElementById('info-AREA2').textContent;
    const status = document.getElementById('info-FacilityStatus').textContent;
    const action = document.getElementById('info-action').textContent;
    const Fdate = document.getElementById('info-Fdate').textContent;


    // الحصول على الإحداثيات والتأكد من إزالة أي مسافات إضافية
    let coordinates = document.getElementById('info-coordinates').textContent.trim();
    coordinates = coordinates.replace(/\s*,\s*/g, ","); // إزالة المسافات حول الفاصلة

    // رابط خرائط جوجل
    const googleMapsLink = `https://www.google.com/maps?q=${coordinates}`;

    // عنوان الرسالة
    const subject = "معلومات النقطة";

    // نص الرسالة
    const body = `معلومات النقطة:
الاسم: ${name}
العلامة التجارية: ${brandName}
رقم الرخصة: ${lic}
المنطقة: ${area}
المنطقة الفرعية: ${subarea}
القطاع الجغرافي: ${sector}
الوصف التفصيلي: ${AREA2}
حالة المنشأة: ${status}
تاريخ آخر زيارة: ${Fdate}
الإجراء: ${action}
الإحداثيات: ${coordinates}
رابط الموقع على خرائط جوجل: ${googleMapsLink}`;

    // فتح رابط البريد الإلكتروني
    const mailtoURL = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.open(mailtoURL, '_blank');
}
</script>

    <script>
        function toggleVisibility(id) {
            var element = document.getElementById(id);
            if (element.classList.contains('hidden')) {
                element.classList.remove('hidden');
            } else {
                element.classList.add('hidden');
            }
        }
        var map = L.map('map').setView([25.276987, 55.296249], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        var allPointsLayer = L.layerGroup().addTo(map);
        var pointsData = [];
        pointsData.push({latitude: 25.434907, longitude: 55.583596, AREA2: '', sector: 8, color: 'cyan', lightColor: 'lightcyan', sectorColor: 'indigo', fname: 'كراكر & باكر ش م ح', area: 'المنطقة الحرة بالحمرية', subarea: '', BrandName: '', FacilityStatus: 'نشط', lic: '16198', subunit: 'مصانع الاغذية', Fdate: '03/04/2025', action: 'انذار'});
        pointsData.push({latitude: 25.370217213581185, longitude: 55.40521375825051, AREA2: 'محل رقم 3', sector: 2, color: 'cyan', lightColor: 'lightcyan', sectorColor: 'darkorange', fname: 'النجار لتجارة الأسماك المملحة ش ذ م م - فرع الشارقة', area: 'بودانق', subarea: '', BrandName: '', FacilityStatus: 'تعهد عدم ممارسة النشاط', lic: '767553', subunit: '', Fdate: '', action: 'انذار'});
        pointsData.push({latitude: 25.347119429556994, longitude: 55.40348992938506, AREA2: 'محل رقم 5 + 6', sector: 2, color: 'cyan', lightColor: 'lightcyan', sectorColor: 'darkorange', fname: 'كافتيريا عيون السلسبيل', area: 'اليرموك', subarea: '', BrandName: '', FacilityStatus: 'تعهد عدم ممارسة النشاط', lic: '773052', subunit: '', Fdate: '', action: 'انذار'});
        pointsData.push({latitude: 25.30548681794288, longitude: 55.36773492939049, AREA2: '', sector: 1, color: 'cyan', lightColor: 'lightcyan', sectorColor: 'darkblue', fname: 'بقالة المياة الزرقاء', area: 'الممزر', subarea: '', BrandName: '', FacilityStatus: 'تعهد عدم ممارسة النشاط', lic: '779585', subunit: '', Fdate: '', action: 'مخالفة'});
        pointsData.push({latitude: 25.312743998054305, longitude: 55.47685571404563, AREA2: '', sector: 5, color: 'cyan', lightColor: 'lightcyan', sectorColor: 'saddlebrown', fname: 'سوبرماركت اوول دي ماركت ش ذ م م فرع 1', area: 'الجادة', subarea: '', BrandName: '', FacilityStatus: 'تعهد عدم ممارسة النشاط', lic: '906053', subunit: '', Fdate: '', action: 'انذار'});
        pointsData.push({latitude: 25.307753209173377, longitude: 55.45870510280212, AREA2: '', sector: 2, color: 'cyan', lightColor: 'lightcyan', sectorColor: 'darkorange', fname: 'سوبرماركت حسنة محمد ذ م م ش ش و', area: 'تجارية مويلح', subarea: '', BrandName: '', FacilityStatus: 'نشط', lic: '914178', subunit: '', Fdate: '', action: 'انذار'});
        pointsData.push({latitude: 25.294272555416065, longitude: 55.47808821349145, AREA2: '', sector: 7, color: 'cyan', lightColor: 'lightcyan', sectorColor: 'firebrick', fname: 'جايم ايس كريم', area: 'المدينة الجامعية', subarea: '', BrandName: '', FacilityStatus: 'نشط', lic: '1122167', subunit: '', Fdate: '', action: 'انذار'});

        function renderPoints(points) {
            allPointsLayer.clearLayers();
            points.forEach(function(point) {
                var pointMarker = L.circleMarker([point.latitude, point.longitude], {
                    color: point.sectorColor,
                    fillColor: point.color,
                    fillOpacity: 1,
                    radius: 5
                }).addTo(allPointsLayer);
                pointMarker.on('click', function() {
                    $('#info-name').text(point.fname);
                    $('#info-BrandName').text(point.BrandName);
                    $('#info-AREA2').text(point.AREA2);
                    $('#info-FacilityStatus').text(point.FacilityStatus);
                    $('#info-sector').text(point.sector);
                    $('#info-area').text(point.area);
                    $('#info-subarea').text(point.subarea);
                    $('#info-subunit').text(point.subunit);
                    $('#info-lic').text(point.lic);
                    var d = new Date(point.Fdate);
                    var dd = ('0' + d.getDate()).slice(-2);
                    var mm = ('0' + (d.getMonth() + 1)).slice(-2);
                    var yyyy = d.getFullYear();
                    $('#info-Fdate').text(dd + '-' + mm + '-' + yyyy);
                    $('#info-action').text(point.action);
                    $('#info-coordinates').text(point.latitude + ', ' + point.longitude);
                });
                pointMarker.on('dblclick', function() {
                    window.open('https://www.google.com/maps?q=' + point.latitude + ',' + point.longitude, '_blank');
                });
            });
            updateTotals(points);
        }
        function filterPoints() {
            var selectedactions = [];
            $('.action-filter:checked').each(function() {
                selectedactions.push($(this).val());
            });
            var selectedSectors = [];
            $('.sector-filter:checked').each(function() {
                selectedSectors.push($(this).val());
            });
            var searchText = $('#search-lic').val().toLowerCase();
            var dateFrom = new Date($('#date-from').val());
            var dateTo = new Date($('#date-to').val());
            var isDateFilterActive = !isNaN(dateFrom.getTime()) && !isNaN(dateTo.getTime());
            var filteredPoints = pointsData.filter(function(point) {
                var actionMatch = selectedactions.length === 0 || selectedactions.includes(point.action);
                var sectorMatch = selectedSectors.length === 0 || selectedSectors.includes(String(point.sector));
                var formatDate = function(dateStr) {
                    var d = new Date(dateStr);
                    var day = ('0' + d.getDate()).slice(-2);
                    var month = ('0' + (d.getMonth() + 1)).slice(-2);
                    var year = d.getFullYear();
                    return day + '-' + month + '-' + year;
                };
                var searchMatch = searchText === '' || point.lic.toLowerCase().includes(searchText) || point.fname.toLowerCase().includes(searchText) || point.BrandName.toLowerCase().includes(searchText) || point.area.toLowerCase().includes(searchText) || point.FacilityStatus.toLowerCase().includes(searchText) || point.subunit.toLowerCase().includes(searchText) || point.subarea.toLowerCase().includes(searchText) || formatDate(point.Fdate).includes(searchText);
                var dateMatch = true;
                if (isDateFilterActive) {
                    var pointDate = new Date(point.Fdate);
                    dateMatch = pointDate >= dateFrom && pointDate <= dateTo;
                }
                return actionMatch && sectorMatch && searchMatch && dateMatch;
            });
            renderPoints(filteredPoints);
        }
        $('#search-lic').on('input', function() {
            filterPoints();
        });
        function updateTotals(points) {
            var totalsHtml = '<h4>إجمالي النقاط: ' + points.length + '</h4>';
            var sectorCounts = {};
            var actionCounts = {};
            points.forEach(function(point) {
                sectorCounts[point.sector] = (sectorCounts[point.sector] || 0) + 1;
                actionCounts[point.action] = (actionCounts[point.action] || 0) + 1;
            });
            totalsHtml += '<h5>القطاعات:</h5><ul>';
            totalsHtml += '<li>القطاع 1: ' + (sectorCounts['1'] || 0) + '</li>';
            totalsHtml += '<li>القطاع 2: ' + (sectorCounts['2'] || 0) + '</li>';
            totalsHtml += '<li>القطاع 3: ' + (sectorCounts['3'] || 0) + '</li>';
            totalsHtml += '<li>القطاع 4: ' + (sectorCounts['4'] || 0) + '</li>';
            totalsHtml += '<li>القطاع 5: ' + (sectorCounts['5'] || 0) + '</li>';
            totalsHtml += '<li>القطاع 6: ' + (sectorCounts['6'] || 0) + '</li>';
            totalsHtml += '<li>مراكز التسوق والمناطق السياحية 7: ' + (sectorCounts['7'] || 0) + '</li>';
            totalsHtml += '<li>المنشات الصناعية 8: ' + (sectorCounts['8'] || 0) + '</li>';
            totalsHtml += '<li>رخصة اعتماد 9: ' + (sectorCounts['9'] || 0) + '</li>';
            totalsHtml += '<li>المقاصف المدرسية 10: ' + (sectorCounts['10'] || 0) + '</li>';
            totalsHtml += '<li>المزارع 11: ' + (sectorCounts['11'] || 0) + '</li>';
            totalsHtml += '</ul><h5>الإجراءات:</h5><ul>';
            totalsHtml += '<li>انذار: ' + (actionCounts['انذار'] || 0) + '</li>';
            totalsHtml += '<li>مخالفة: ' + (actionCounts['مخالفة'] || 0) + '</li>';
            totalsHtml += '<li>عينات: ' + (actionCounts['عينات'] || 0) + '</li>';
            totalsHtml += '<li>متابعة: ' + (actionCounts['متابعة'] || 0) + '</li>';
            totalsHtml += '<li>مغلق: ' + (actionCounts['مغلق'] || 0) + '</li>';
            totalsHtml += '<li>تقرير: ' + (actionCounts['تقرير'] || 0) + '</li>';
            totalsHtml += '<li>مناسب: ' + (actionCounts['مناسب'] || 0) + '</li>';
            totalsHtml += '</ul>';
            $('#totals').html(totalsHtml);
        }
        renderPoints(pointsData);
    </script>

<script>
// تشغيل الصوت عند الاقتراب
var alertAudio = new Audio('https://www.soundjay.com/button/beep-07.wav');

// طلب إذن الإشعارات
if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission();
}

function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const φ1 = lat1 * Math.PI / 180;
    const φ2 = lat2 * Math.PI / 180;
    const Δφ = (lat2 - lat1) * Math.PI / 180;
    const Δλ = (lon2 - lon1) * Math.PI / 180;

    const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
              Math.cos(φ1) * Math.cos(φ2) *
              Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

    return R * c;
}

let notifiedPoints = [];

function checkProximity() {
    if (!navigator.geolocation) {
        console.log("الموقع غير مدعوم في هذا المتصفح");
        return;
    }

    navigator.geolocation.getCurrentPosition(position => {
        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;

        pointsData.forEach(point => {
            if (point.action === 'انذار') {
                const distance = getDistance(userLat, userLon, point.latitude, point.longitude);
                if (distance < 500 && !notifiedPoints.includes(point.lic)) {
                    const timeEst = Math.round((distance / 80) * 60);

                    // تشغيل الصوت
                    alertAudio.play();

                    // إظهار إشعار
                    if ("Notification" in window && Notification.permission === "granted") {
                        new Notification("تنبيه من الخريطة", {
                            body: `🟡 أنت على بعد ${timeEst} دقيقة من ${point.fname}`,
                            icon: 'https://cdn-icons-png.flaticon.com/512/684/684908.png'
                        });
                    }

                    notifiedPoints.push(point.lic); // منع التكرار
                }
            }
        });
    });
}

setInterval(checkProximity, 30000);
</script>

</body>
</html>
