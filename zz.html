<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù‚Ø±ÙŠØ¨Ø©</title>
</head>
<body>
    <select id="mode">
        <option value="car">ğŸš— Ø³ÙŠØ§Ø±Ø©</option>
        <option value="walk">ğŸš¶â€â™‚ï¸ Ù…Ø´ÙŠ</option>
    </select>

<script>
var alertAudio = new Audio('https://www.soundjay.com/button/beep-07.wav');

// Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission();
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const Ï†1 = lat1 * Math.PI / 180;
    const Ï†2 = lat2 * Math.PI / 180;
    const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
    const Î”Î» = (lon2 - lon1) * Math.PI / 180;

    const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
              Math.cos(Ï†1) * Math.cos(Ï†2) *
              Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// Ø§Ù„Ø²Ù…Ù† Ø­Ø³Ø¨ Ø§Ù„ÙˆØ¶Ø¹ ÙˆØ§Ù„Ø²Ø­Ø§Ù…
function getDrivingTimeInMinutes(distanceMeters) {
    const mode = document.getElementById("mode").value;
    let speedKph;

    if (mode === 'walk') {
        speedKph = 5;
    } else {
        const now = new Date();
        const totalMinutes = now.getHours() * 60 + now.getMinutes();

        if (totalMinutes >= 360 && totalMinutes < 450) {
            speedKph = 10; // 6:00 - 7:30
        } else if (totalMinutes >= 450 && totalMinutes < 570) {
            speedKph = 5;  // 7:30 - 9:30
        } else if (totalMinutes >= 570 && totalMinutes < 840) {
            speedKph = 15; // 9:30 - 14:00
        } else if (totalMinutes >= 840 && totalMinutes < 1020) {
            speedKph = 8;  // 14:00 - 17:00
        } else if (totalMinutes >= 1020 && totalMinutes < 1320) {
            speedKph = 5;  // 17:00 - 22:00
        } else {
            speedKph = 20; // Ø¨Ø¹Ø¯ 10 Ù…Ø³Ø§Ø¡Ù‹
        }
    }

    const speedMetersPerMinute = (speedKph * 1000) / 60;
    return distanceMeters / speedMetersPerMinute;
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
function showNotification(point, time) {
    const msg = `
ğŸ“ Ø§Ù„Ø§Ø³Ù…: ${point.fname}
ğŸ“ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${point.area}
ğŸ“„ Ø§Ù„Ø±Ø®ØµØ©: ${point.lic}
ğŸ¢ Ø§Ù„Ù‚Ø·Ø§Ø¹: ${point.sector}
ğŸ“… Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©: ${point.Fdate}
â³ Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù„Ù„ÙˆØµÙˆÙ„: ${Math.round(time)} Ø¯Ù‚ÙŠÙ‚Ø©
    `;
    alertAudio.play();

    if ("Notification" in window && Notification.permission === "granted") {
        const notification = new Notification("ğŸš¨ ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø±ÙŠØ¨", {
            body: msg,
            icon: "https://cdn-icons-png.flaticon.com/512/565/565547.png"
        });

        notification.onclick = () => {
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${point.latitude},${point.longitude}`, '_blank');
        };
    }

    const confirmReview = confirm(msg + "\nÙ‡Ù„ ØªØ±ØºØ¨ Ø¨Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¢Ù†ØŸ");
    if (confirmReview) {
        window.open(`https://www.google.com/maps/dir/?api=1&destination=${point.latitude},${point.longitude}`, '_blank');
    }
}

// Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ¬Ø±Ø¨Ø© (Ù…Ø«Ø§Ù„ ÙÙ‚Ø·)
const pointsData = [
    {
        fname: "Ù…Ø·Ø¹Ù… Ø§Ù„Ø¯Ø§Ù†Ø©",
        area: "Ø§Ù„Ù†Ø§ØµØ±ÙŠØ©",
        lic: "123456",
        sector: "Ù…Ø·Ø§Ø¹Ù…",
        Fdate: "2025-04-20",
        latitude: 25.3621,
        longitude: 55.3912,
        action: "Ø§Ù†Ø°Ø§Ø±"
    }
];

let notified = new Set();

function checkNearbyWarnings() {
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(pos => {
        const userLat = pos.coords.latitude;
        const userLon = pos.coords.longitude;

        pointsData.forEach(point => {
            if (point.action === 'Ø§Ù†Ø°Ø§Ø±') {
                const distance = getDistance(userLat, userLon, point.latitude, point.longitude);
                const time = getDrivingTimeInMinutes(distance);
                if (time <= 5 && !notified.has(point.fname)) {
                    showNotification(point, time);
                    notified.add(point.fname);
                }
            }
        });
    });
}

// ØªØ­Ù‚Ù‚ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
setInterval(checkNearbyWarnings, 30000);

// ØªØºÙŠÙŠØ± Ø§Ù„ÙˆØ¶Ø¹ ÙŠØ¹ÙŠØ¯ Ø§Ù„ÙØ­Øµ
document.getElementById("mode").addEventListener("change", () => {
    notified.clear();
    checkNearbyWarnings();
});
</script>
</body>
</html>
