<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹</title>
</head>
<body>
    <div id="modeSelector">
        <label>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ¶Ø¹:</label>
        <select id="mode">
            <option value="walk">ğŸš¶â€â™‚ï¸ Ù…Ø´ÙŠ</option>
            <option value="car">ğŸš— Ø³ÙŠØ§Ø±Ø©</option>
        </select>
    </div>

    <button onclick="triggerTest()">ğŸ”” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</button>

    <script>
        var alertAudio = new Audio('https://www.soundjay.com/button/beep-07.wav');

        // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        if ("Notification" in window && Notification.permission !== "granted") {
            Notification.requestPermission();
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù†Ù‚Ø·ØªÙŠÙ†
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;  // Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨Ø§Ù„Ù…ØªØ±
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø²Ù…Ù† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø®ØªØ§Ø±
        function getDrivingTimeInMinutes(distanceMeters) {
            const modeElement = document.getElementById("mode");
            if (!modeElement) return Infinity;

            const mode = modeElement.value;
            let speedKph;

            if (mode === 'walk') {
                speedKph = 5; // 5 ÙƒÙ…/Ø³Ø§Ø¹Ø© Ù„Ù„Ù…Ø´ÙŠ
            } else {
                const now = new Date();
                const hour = now.getHours();
                const minute = now.getMinutes();
                const totalMinutes = hour * 60 + minute;

                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø±Ø¹Ø© Ø­Ø³Ø¨ Ø§Ù„Ø²Ø­Ø§Ù…
                if (totalMinutes >= 360 && totalMinutes < 450) {
                    speedKph = 10;
                } else if (totalMinutes >= 450 && totalMinutes < 570) {
                    speedKph = 5;
                } else if (totalMinutes >= 570 && totalMinutes < 840) {
                    speedKph = 15;
                } else if (totalMinutes >= 840 && totalMinutes < 1020) {
                    speedKph = 8;
                } else if (totalMinutes >= 1020 && totalMinutes < 1320) {
                    speedKph = 5;
                } else {
                    speedKph = 20;
                }
            }

            const speedMetersPerMinute = (speedKph * 1000) / 60;
            return distanceMeters / speedMetersPerMinute;
        }

        const notified = new Set();

        // Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ù…Ø«Ø§Ù„
        const pointsData = [
            {
                action: 'Ø§Ù†Ø°Ø§Ø±',
                fname: 'Ù…Ø·Ø¹Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±',
                area: 'Ø§Ù„Ù…Ø¬Ø§Ø²',
                lic: '1001',
                sector: 'ØºØ°Ø§Ø¦ÙŠ',
                Fdate: '2025-05-06',
                latitude: 25.346,
                longitude: 55.420
            }
        ];

        // Ø¯Ø§Ù„Ø© Ù„ÙØ­Øµ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚Ø±ÙŠØ¨Ø©
        function checkNearbyWarnings() {
            if (!navigator.geolocation) return;

            navigator.geolocation.getCurrentPosition(pos => {
                const userLat = pos.coords.latitude;
                const userLon = pos.coords.longitude;

                pointsData.forEach(point => {
                    if (point.action === 'Ø§Ù†Ø°Ø§Ø±') {
                        const distance = getDistance(userLat, userLon, point.latitude, point.longitude);
                        const time = getDrivingTimeInMinutes(distance);
                        if (time <= 5 && !notified.has(point.fname)) {
                            const msg = `
ğŸ“ Ø§Ù„Ø§Ø³Ù…: ${point.fname}
ğŸ“ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${point.area}
ğŸ“„ Ø§Ù„Ø±Ø®ØµØ©: ${point.lic}
ğŸ¢ Ø§Ù„Ù‚Ø·Ø§Ø¹: ${point.sector}
ğŸ“… Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©: ${point.Fdate}
â³ Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù„Ù„ÙˆØµÙˆÙ„: ${Math.round(time)} Ø¯Ù‚ÙŠÙ‚Ø©
                            `;
                            alertAudio.play();
                            const confirmReview = confirm(msg + "Ù‡Ù„ ØªØ±ØºØ¨ Ø¨Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¢Ù†ØŸ");
                            if (confirmReview) {
                                window.open(`https://www.google.com/maps/dir/?api=1&destination=${point.latitude},${point.longitude}`, '_blank');
                            }
                            notified.add(point.fname);
                        }
                    }
                });
            }, err => {
                alert("âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹: " + err.message);
            });
        }

        // ÙØ­Øµ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
        setInterval(checkNearbyWarnings, 30000);

        // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙˆØ¶Ø¹
        document.getElementById("mode").addEventListener("change", () => {
            notified.clear();
            checkNearbyWarnings();
        });

        // Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ØµÙˆØª ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø±
        function triggerTest() {
            alertAudio.play();
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification("ğŸ“¢ Ø¥Ø´Ø¹Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ", {
                    body: "Ù‡Ø°Ø§ Ø¥Ø´Ø¹Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­ ğŸ‰",
                    icon: "https://cdn-icons-png.flaticon.com/512/484/484167.png"
                });
            } else {
                alert("ğŸ”” Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØºÙŠØ± Ù…ÙØ¹Ù„Ø© Ø£Ùˆ Ù…Ø±ÙÙˆØ¶Ø©.");
            }
        }
    </script>
</body>
</html>
