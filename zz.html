<!DOCTYPE html>
<html lang='ar' dir='rtl'>
<head>
    <meta charset='utf-8'>
    <title>خريطة قسم رقابة الصحة العامة</title>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'>
    <link rel='stylesheet' href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css' />
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css' />
    <script src='https://cdn.jsdelivr.net/npm/chart.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2'></script>
    <script src='https://unpkg.com/xlsx/dist/xlsx.full.min.js'></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');

        /* Color Palette */
        :root {
            --primary-green: #4CAF50; /* A vibrant green */
            --darker-green: #388E3C; /* Darker shade for hover */
            --light-beige: #FFFDD0; /* A soft, warm beige */
            --white: #FFFFFF;
            --text-dark: #333;
            --text-light: #fff;
            --accent-blue: #1a73e8; /* Keeping a blue accent for headings/links */
        }

        html, body { height: 100%; margin: 0; padding: 0; }
        body { font-family: 'Cairo', sans-serif; background: #f8f9fa; min-height: 100vh !important; font-size: 14px; color: var(--text-dark); }
        #map { height: 100vh; width: 100vw; min-height: 100vh; background-color: #f0f0f0; }

        /* Logo Bar */
        #logo-bar {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1201;
            width: 55px;
            height: 100vh;
            background: var(--primary-green); /* Green background */
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 10px;
            border-radius: 0 15px 15px 0;
            box-shadow: 2px 0 15px rgba(0,0,0,0.1);
        }
        #logo-bar img {
            width: 42px;
            height: 42px;
            margin-bottom: 15px;
        }
        #logo-bar .logo-caption {
            font-size: 12px; font-weight: bold; color: var(--text-light); /* White text */
            margin-bottom: 20px; text-align: center;
        }
        #logo-bar .panel-toggle-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 18px;
            background: var(--darker-green); /* Darker green for buttons */
            color: var(--text-light);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: background 0.2s ease, transform 0.2s ease;
        }
        #logo-bar .panel-toggle-btn:hover { background: var(--primary-green); transform: translateY(-2px); }
        #logo-bar .panel-toggle-btn.active { background: var(--primary-green); }

        /* Panels (Controls, Info, Charts) */
        #controls, #info, #charts-panel {
            position: fixed;
            top: 15px;
            background: var(--white); /* White background */
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.15);
            font-size: 13px;
            max-height: 90vh;
            overflow-y: auto;
            min-width: 250px;
            width: 280px;
            transition: left 0.3s ease, right 0.3s ease, width 0.3s ease;
            z-index: 1050;
            display: none;
            border: 1px solid #e0e0e0;
        }
        #controls { left: 75px; max-width: 320px; }
        #info { right: 15px; max-width: 350px; }
        #charts-panel { left: 380px; width: 360px; max-width: 380px;}

        /* Dashboard Summary */
        #dashboard-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .dashboard-box {
            flex: 1 0 48%;
            background: var(--light-beige); /* Beige background */
            border-radius: 8px;
            text-align: center;
            padding: 10px 5px;
            min-width: 80px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #d2e3fc; /* A subtle border that complements beige */
        }
        .dashboard-box strong { display:block; font-size:18px; color:var(--accent-blue); margin-bottom: 3px; }
        .dashboard-box span { font-size:12px; color:var(--text-dark); }

        /* Form Elements */
        label { display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; padding: 2px 0; border-radius: 3px; }
        label:hover { background-color: #f5f5f5; }
        input[type='checkbox'] { margin-left: 10px; transform: scale(1.1); }
        input[type='text'], input[type='date'], select, textarea {
            width: calc(100% - 10px);
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            font-size: 13px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input[type='text']:focus, input[type='date']:focus, select:focus, textarea:focus {
            border-color: var(--primary-green); /* Green focus border */
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2); /* Green shadow */
            outline: none;
        }

        /* Buttons */
        button:not(.panel-toggle-btn) {
            background-color: var(--primary-green); /* Green buttons */
            color: var(--text-light);
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            margin-bottom: 8px;
            width: 100%;
            text-align: center;
            box-sizing: border-box;
            transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        button:not(.panel-toggle-btn):hover { background-color: var(--darker-green); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

        /* Color Dot for Filters */
        .color-dot {
            width: 13px; height: 13px; border-radius: 50%; display: inline-block; margin-right: 5px; border: 1px solid #888;
            vertical-align: middle;
        }

        /* Filter Sections */
        #controls hr { margin: 15px 0; border-color: #eee; }
        .filter-section-header {
            background-color: var(--primary-green); /* Green header */
            color: var(--text-light);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 5px;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s ease;
        }
        .filter-section-header:hover { background-color: var(--darker-green); }
        .filter-content {
            padding: 8px 10px;
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            margin-bottom: 10px;
            display: none;
            background-color: #fdfdfd;
        }
        .filter-content label { padding-right: 8px; padding-left: 8px; }
        .filter-search-box { width: calc(100% - 16px); margin-bottom: 8px; font-size:12px; padding: 6px; border-radius: 4px; border: 1px solid #ddd; }

        /* Popup Info Display */
        .popup-info-display div { margin-bottom: 4px; }
        .leaflet-popup-content-wrapper { border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); background: var(--white); }
        .leaflet-popup-content { margin: 10px; max-height: 250px; overflow-y: auto; font-size: 13px;}

        /* Share and Edit Buttons */
        .share-buttons button { margin-bottom: 6px; background-color: var(--accent-blue); font-size:13px; }
        .share-buttons button:hover { background-color: darken(var(--accent-blue), 10%); }
        .edit-data-btn {
            background-color: #ffc107; /* Warning yellow */
            color: var(--text-dark);
            padding: 8px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 8px;
            width: 100%;
            text-align: center;
            box-sizing: border-box;
            border: none;
            transition: background 0.2s ease, transform 0.2s ease;
        }
        .edit-data-btn:hover { background-color: #e0a800; transform: translateY(-1px); }
        .edit-data-btn[style*="background-color: #17a2b8"] { background-color: var(--primary-green) !important; color: white; } /* Green for add inspection */
        .edit-data-btn[style*="background-color: #17a2b8"]:hover { background-color: var(--darker-green) !important; }
        .edit-data-btn[style*="background-color: #dc3545"] { background-color: #dc3545 !important; color: white; } /* Danger red for delete */
        .edit-data-btn[style*="background-color: #dc3545"]:hover { background-color: #c82333 !important; }

        /* Charts Panel */
        #charts-panel h3, #charts-panel h4 { font-size:15px; margin-top:10px; margin-bottom: 10px; color:var(--accent-blue); }
        #charts-panel canvas { background:var(--white); border-radius:8px; padding: 5px; border: 1px solid #eee;}

        /* Print Styles */
        @media print {
            body > *:not(#print-area) { display: none !important; }
            #print-area {
                display: block !important;
                font-family: 'Cairo', sans-serif;
                direction: rtl;
                width: 100vw;
                background: #fff !important;
                padding: 15px 3vw;
                box-sizing: border-box;
            }
            #print-area .report-header {
                display: flex; align-items: center; gap: 20px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;
            }
            #print-area .report-header img {
                width: 60px; height: 60px; margin-left: 15px;
            }
            #print-area .report-title {
                font-size: 20px; color: var(--accent-blue); margin: 0 0 5px 0; font-weight: bold;
            }
            #print-area .report-table {
                width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 13px; background: #fff;
                table-layout: auto; /* Allow column width to adjust to content */
            }
            #print-area .report-table th, #print-area .report-table td {
                border: 1px solid #d0d0d0; padding: 5px 8px; text-align: right;
            }
            #print-area .report-table th {
                background: #e9ecef; font-weight: bold; color: var(--text-dark);
            }
            #print-area .report-table tbody tr {
                page-break-inside: avoid; /* Keep table rows together */
            }
            #print-area .report-table thead {
                display: table-header-group; /* Repeat table header on each page */
            }
        }

        /* Responsive Adjustments */
        @media (max-width: 900px) {
            #controls, #info, #charts-panel {
                left: 65px !important; right: unset !important; width: 95vw !important; max-width: 95vw;
                border-radius: 0 0 15px 15px;
                transform: none !important;
                top: 10px;
            }
            #info { right: 10px !important; left: unset !important; }
            #charts-panel { left: 55vw !important; width: 95vw !important; }
            #logo-bar { width: 50px; }
            #logo-bar img { width:38px;height:38px; }
        }
        @media (max-width: 600px) {
            #controls, #info, #charts-panel {
                left: 55px !important; right: unset !important; width: 90vw !important; max-width: 90vw !important;
                border-radius: 0 0 12px 12px;
                font-size: 12px !important;
                min-height: unset !important;
                padding: 10px;
            }
            #info { right: 5px !important; left: unset !important; }
            #charts-panel { left: 50vw !important; width: 90vw !important; }
            #map { min-height: 100vh !important; }
            #logo-bar { width: 45px; }
            #logo-bar img { width:32px;height:32px; }
            .dashboard-box strong { font-size: 16px; }
            .dashboard-box span { font-size: 11px; }
        }

        /* Notification Styling */
        #notification-popup {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--text-dark); /* Dark background for info/default */
            color: var(--text-light);
            padding: 12px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 2000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            font-size: 14px;
            text-align: center;
        }
        #notification-popup.show {
            opacity: 1;
            display: block;
        }
        #notification-popup.success {
            background-color: var(--primary-green); /* Green for success */
        }
        #notification-popup.error {
            background-color: #dc3545; /* Red for error */
        }
        /* Buttons within interactive notification */
        #notification-popup button {
            background-color: var(--primary-green); /* Confirm button green */
            color: var(--text-light);
        }
        #notification-popup button:hover {
            background-color: var(--darker-green);
        }
        #notification-popup button[style*="background-color: #6c757d"] {
            background-color: #6c757d !important; /* Cancel button grey */
        }
        #notification-popup button[style*="background-color: #6c757d"]:hover {
            background-color: #5a6268 !important;
        }
    </style>
    <script src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'></script>
    <script src='https://code.jquery.com/jquery-3.7.1.min.js'></script>
</head>
<body>
    <div id="logo-bar">
        <img src="shjmunlogo.png" alt="شعار بلدية الشارقة">
        <div class="logo-caption">قسم الرقابة الصحية</div>
        <button class='panel-toggle-btn' id='toggleControlsBtn' title="لوحة الفلاتر"><i class='fas fa-bars'></i></button>
        <button class='panel-toggle-btn' id='toggleChartsBtn' title="الرسوم البيانية"><i class='fas fa-chart-pie'></i></button>
        <button class='panel-toggle-btn' id='toggleInfoBtn' title="معلومات النقطة"><i class='fas fa-info-circle'></i></button>
    </div>
    <div id='map'></div>
    <div id='controls'>
        <div id="dashboard-summary">
            <div class="dashboard-box">
                <strong id="summary-total">0</strong>
                <span>عدد المنشآت</span>
            </div>
            <div class="dashboard-box">
                <strong id="summary-total-actions">0</strong>
                <span>عدد الإجراءات</span>
            </div>
        </div>
        <input type="text" id="main-search-box" placeholder="بحث باسم المنشأة أو رقم الرخصة...">
        <div style="margin-bottom:6px;">
            <label>من تاريخ: <input type="date" id="inspection-date-from" style="width:74px;display:inline-block;margin-left:4px;"></label>
            <label>إلى: <input type="date" id="inspection-date-to" style="width:74px;display:inline-block;"></label>
            <label style="margin-bottom:0;"><input type="checkbox" id="show-all-facilities" style="margin-left:5px;"> عرض الجميع</label>
        </div>
        <div class="filter-section-header" onclick="toggleFilterContent('action-filters-content')">
            <span><i class='fas fa-flag'></i> الإجراء</span> <i class="fas fa-chevron-down"></i>
        </div>
        <div id='action-filters-content' class='filter-content'>
            <input class="filter-search-box" type="text" placeholder="بحث في الإجراءات..." oninput="filterFilterOptions('action-filters', this.value)">
            <div id='action-filters'></div>
        </div>
        <div class="filter-section-header" onclick="toggleFilterContent('activity-filters-content')">
            <span><i class='fas fa-briefcase'></i> النشاط</span> <i class="fas fa-chevron-down"></i>
        </div>
        <div id='activity-filters-content' class='filter-content'>
            <input class="filter-search-box" type="text" placeholder="بحث في الأنشطة..." oninput="filterFilterOptions('activity-filters', this.value)">
            <div id='activity-filters'></div>
        </div>
        <div class="filter-section-header" onclick="toggleFilterContent('license-issuing-filters-content')">
            <span><i class='fas fa-building'></i> جهة الإصدار</span> <i class="fas fa-chevron-down"></i>
        </div>
        <div id='license-issuing-filters-content' class='filter-content'>
            <input class="filter-search-box" type="text" placeholder="بحث في جهة الإصدار..." oninput="filterFilterOptions('license-issuing-filters', this.value)">
            <div id='license-issuing-filters'></div>
        </div>
        <div class="filter-section-header" onclick="toggleFilterContent('ltype-filters-content')">
            <span><i class='fas fa-id-card'></i> نوع الرخصة</span> <i class="fas fa-chevron-down"></i>
        </div>
        <div id='ltype-filters-content' class='filter-content'>
            <input class="filter-search-box" type="text" placeholder="بحث في نوع الرخصة..." oninput="filterFilterOptions('ltype-filters', this.value)">
            <div id='ltype-filters'></div>
        </div>
        <div class="filter-section-header" onclick="toggleFilterContent('facility-status-filters-content')">
            <span><i class='fas fa-check-circle'></i> حالة المنشأة</span> <i class="fas fa-chevron-down"></i>
        </div>
        <div id='facility-status-filters-content' class='filter-content'>
            <input class="filter-search-box" type="text" placeholder="بحث في حالة المنشأة..." oninput="filterFilterOptions('facility-status-filters', this.value)">
            <div id='facility-status-filters'></div>
        </div>
        <div class="filter-section-header" onclick="toggleFilterContent('unit-filters-content')">
            <span><i class='fas fa-users'></i> الوحدة</span> <i class="fas fa-chevron-down"></i>
        </div>
        <div id='unit-filters-content' class='filter-content'>
            <input class="filter-search-box" type="text" placeholder="بحث في الوحدة..." oninput="filterFilterOptions('unit-filters', this.value)">
            <div id='unit-filters'></div>
        </div>
        <div class="filter-section-header" onclick="toggleFilterContent('shjhsp-filters-content')">
            <span><i class='fas fa-file-alt'></i> SHJHSP</span> <i class="fas fa-chevron-down"></i>
        </div>
        <div id='shjhsp-filters-content' class='filter-content'>
            <input class="filter-search-box" type="text" placeholder="بحث في SHJHSP..." oninput="filterFilterOptions('shjhsp-filters', this.value)">
            <div id='shjhsp-filters'></div>
        </div>
        <div class="filter-section-header" onclick="toggleFilterContent('hazard-class-filters-content')">
            <span><i class='fas fa-exclamation-triangle'></i> درجة الخطورة</span> <i class="fas fa-chevron-down"></i>
        </div>
        <div id='hazard-class-filters-content' class='filter-content'>
            <input class="filter-search-box" type="text" placeholder="بحث في درجة الخطورة..." oninput="filterFilterOptions('hazard-class-filters', this.value)">
            <div id='hazard-class-filters'></div>
        </div>
        <hr>
        <label for="mode" style="margin-bottom: 10px;">وضع التنقل:</label>
        <select id="mode" style="width: calc(100% - 20px); padding: 8px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ccc; font-size: 13px;">
            <option value="car">سيارة</option>
            <option value="walk">مشي</option>
        </select>
        <button onclick="checkNearbyWarnings()"><i class='fas fa-bell'></i> التحقق من تحذيرات الانتهاء</button>
        <button onclick="showPanel('charts-panel');"><i class='fas fa fa-chart-pie'></i> عرض الرسوم البيانية</button>
        <button onclick="printAllFilteredRecords()"><i class='fas fa-print'></i> طباعة تقرير البيانات</button>
        <button onclick="exportExcel()"><i class='fas fa-file-excel'></i> تصدير البيانات إلى Excel</button>
        <button onclick="openNewEstablishmentForm()"><i class='fas fa-plus-circle'></i> إضافة منشأة جديدة</button>
    </div>
    <div id='info'>
        <h3 style="margin-bottom:10px;font-size:15px; color:var(--accent-blue);">معلومات المنشأة</h3>
        <div id="info-details-container">
            <p>اضغط على نقطة في الخريطة لعرض تفاصيلها.</p>
        </div>
        <div id="previous-inspections" style="margin-top:15px;"></div>
        <div class="share-buttons">
            <button class="whatsapp-btn" id="whatsapp-btn"><i class="fab fa-whatsapp"></i> واتساب</button>
            <button class="email-btn" id="email-btn"><i class="fas fa-envelope'></i> بريد إلكتروني</button>
            <button class="location-btn" id="location-btn"><i class="fas fa-map-marker-alt"></i> الموقع الجغرافي</button>
            <button class="edit-data-btn" id="edit-data-btn"><i class="fas fa-edit"></i> تعديل بيانات المنشأة</button>
            <button class="edit-data-btn" style="background-color: #17a2b8;" id="add-inspection-btn"><i class="fas fa-clipboard-list"></i> إضافة/تعديل زيارة تفتيش</button>
            <button class="edit-data-btn" style="background-color: #dc3545;" id="delete-establishment-btn"><i class="fas fa-trash'></i> حذف المنشأة</button>
        </div>
        <button onclick="$('#info').hide();" style="margin-top:10px; background-color: #6c757d;">إغلاق</button>
    </div>
    <div id="charts-panel">
        <h3 style="font-size:15px;margin-bottom:10px; color:var(--accent-blue);">تقرير الرسوم البيانية</h3>
        <div id="charts-container"></div>
        <button onclick="printChartReport()"><i class='fas fa-print'></i> طباعة تقرير الرسوم البيانية</button>
        <button onclick="$('#charts-panel').hide();" style="background-color: #6c757d;">إغلاق</button>
    </div>
    <div id="print-area" style="display:none;"></div>
    <div id="notification-popup"></div> <script>
        console.log("Start of script execution."); // Debug log
        var map = L.map('map').setView([25.34626, 55.4212], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="https://carto.com/attributions">CARTO</a>',
            maxZoom: 19
        }).addTo(map);
        console.log("Leaflet map initialized."); // Debug log

        var allPointsLayer = L.layerGroup().addTo(map);
        var allRecords = [];
        var filteredRecords = [];
        var actionPriority = ['انذار', 'مهلة', 'مخالفة', 'مناسب'];
        var notified = new Set(); // To track notified facilities for WarningPeriod expiration
        console.log("Global variables initialized."); // Debug log

        function getActionColor(actionString, selectedActions = []) {
            if (!actionString) return '#b2bec3';
            const actions = actionString.split(',').map(a => a.trim());
            if (selectedActions && selectedActions.length > 0) {
                for (let f of selectedActions) {
                    if (actions.includes(f)) return colorForAction(f);
                }
            }
            for (let p of actionPriority) {
                if (actions.includes(p)) return colorForAction(p);
            }
            return '#b2bec3';
        }
        function colorForAction(action) {
            switch (action) {
                case 'انذار': return '#FF9800'; // Orange
                case 'مهلة': return '#FFD600'; // Amber
                case 'مخالفة': return '#D50000'; // Red
                case 'مناسب': return '#009688'; // Teal
                default: return '#b2bec3'; // Grey
            }
        }
        function getActivityColor(activityType) {
            if (!activityType) return '#e0e0e0';
            switch (activityType) {
                case 'تجارة - بيع مستحضرات التجميل': return '#fce4ec'; // Pink A100
                case 'تجارة - بيع الأغذية الصحية': return '#e8f5e9'; // Green A100
                case 'محلات الأعشاب والأغذية الصحية': return '#e0f7fa'; // Cyan A100
                case 'منشأة فندقية': return '#ede7f6'; // Deep Purple A100
                case 'نادي وصالة رياضية': return '#ffecb3'; // Amber A100
                case 'صالون حلاقة رجالي': return '#f3e5f5'; // Purple A100
                case 'مراكز التجميل النسائية': return '#fff3e0'; // Orange A100
                case 'صالون تجميل نسائي': return '#f1f8e9'; // Light Green A100
                default: return '#e0e0e0'; // Grey
            }
        }

        function createPopupContent(record) {
            let contentHtml = `
                <div class="popup-info-display">
                    <div><strong>اسم المنشأة: </strong><span>${record.facility_name || 'غير متوفر'}</span></div>
                    <div><strong>المنطقة: </strong><span>${record.area || 'غير متوفر'}</span></div>
                    <div><strong>النشاط: </strong><span>${record.activity_type || 'غير متوفر'}</span></div>
                    <div><strong>الإجراء الأخير: </strong><span>${record.latest_Action || 'لا يوجد إجراء'}</span></div>
                    <div><strong>تاريخ آخر تفتيش: </strong><span>${record.latest_Inspectiondate || 'لا يوجد'}</span></div>
                </div>
            `;
            return contentHtml;
        }
        function renderPoints(pointsToRender) {
            console.log("renderPoints called with", pointsToRender.length, "points."); // Debug log
            allPointsLayer.clearLayers();
            filteredRecords = pointsToRender;
            var selectedActions = Array.from(document.querySelectorAll('#action-filters input[type="checkbox"].action-filter:checked')).map(cb => cb.value);
            pointsToRender.forEach(function(record) {
                if (record.site_coordinates) {
                    const coords = record.site_coordinates.split(',').map(Number);
                    if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                        var latitude = coords[0];
                        var longitude = coords[1];
                        var pointMarker = L.circleMarker([latitude, longitude], {
                            color: getActivityColor(record.activity_type),
                            weight: 2,
                            fillColor: getActionColor(record.latest_Action, selectedActions),
                            fillOpacity: 0.96,
                            radius: 8
                        }).addTo(allPointsLayer);
                        const popupContent = createPopupContent(record);
                        pointMarker.bindPopup(popupContent);
                        pointMarker.on('popupopen', function (e) {
                            console.log("Marker popup opened for:", record.facility_name); // Debug log
                            // Ensure only the info panel is shown when a marker is clicked
                            $('#info').show();
                            $('#charts-panel').hide();
                            $('#controls').hide();
                            updateInfoPanel(record);
                        });
                    }
                }
            });
            updateMainSummary();
            console.log("Points rendered and summary updated."); // Debug log
        }
        function updateMainSummary() {
            console.log("updateMainSummary called."); // Debug log
            $('#summary-total').text(filteredRecords.length);
            let actions = 0;
            filteredRecords.forEach(r => {
                if (r.latest_Action) {
                    let acts = r.latest_Action.split(',').map(x=>x.trim()).filter(Boolean);
                    actions += acts.length;
                }
            });
            $('#summary-total-actions').text(actions);
        }
        function filterFilterOptions(containerId, searchValue) {
            console.log("filterFilterOptions called for", containerId, "with search:", searchValue); // Debug log
            searchValue = searchValue.trim().toLowerCase();
            $('#' + containerId + ' label').each(function() {
                if (searchValue === '') { $(this).show(); return; }
                let text = $(this).text().toLowerCase();
                if (text.indexOf(searchValue) !== -1) $(this).show();
                else $(this).hide();
            });
        }
        function toggleFilterContent(contentId) {
            console.log("toggleFilterContent called for", contentId); // Debug log
            $(`#${contentId}`).slideToggle(160);
        }
        function showPanel(panel) {
            console.log("showPanel called for:", panel); // Debug log
            // Hide all panels first, then show the requested one
            $('#controls, #info, #charts-panel').hide();
            $("#" + panel).show();
            // Adjust position for responsive layout if needed
            if (panel === 'controls') { $('#controls').css('left', '75px'); }
            else if (panel === 'charts-panel') { $('#charts-panel').css('left', '380px'); }
            else if (panel === 'info') { $('#info').css('right', '15px'); }
        }

        function updateInfoPanel(record) {
            console.log("updateInfoPanel called for record:", record.facility_name); // Debug log
            let infoHtml = `
                <div><strong>معرف المنشأة (ID): </strong><span>${record.facility_ID || 'غير متوفر'}</span></div>
                <div><strong>رقم الرخصة: </strong><span>${record.license_no || 'غير متوفر'}</span></div>
                <div><strong>Unique ID: </strong><span>${record.facility_unq_id || 'غير متوفر'}</span></div>
                <div><strong>اسم المنشأة: </strong><span>${record.facility_name || 'غير متوفر'}</span></div>
                <div><strong>المنطقة: </strong><span>${record.area || 'غير متوفر'}</span></div>
                <div><strong>النشاط: </strong><span>${record.activity_type || 'غير متوفر'}</span></div>
                <div><strong>العلامة التجارية: </strong><span>${record.brand_name || 'غير متوفر'}</span></div>
                <div><strong>جهة الإصدار: </strong><span>${record.LicenseIssuing || 'غير متوفر'}</span></div>
                <div><strong>نوع الرخصة: </strong><span>${record.ltype || 'غير متوفر'}</span></div>
                <div><strong>حالة المنشأة: </strong><span>${record.facility_status || 'غير متوفر'}</span></div>
                <div><strong>الوحدة: </strong><span>${record.unit || 'غير متوفر'}</span></div>
                <div><strong>SHJHSP: </strong><span>${record.shjhsp || 'غير متوفر'}</span></div>
                <div><strong>درجة الخطورة: </strong><span>${record.hazard_class || 'غير متوفر'}</span></div>
                <div><strong>الأنشطة التفصيلية: </strong><span>${record.detailed_activities || 'غير متوفر'}</span></div>
                <div><strong>الإحداثيات: </strong><span>${record.site_coordinates || 'غير متوفر'}</span></div>
                <hr>
                <h4 style="font-size:14px; color:var(--accent-blue);">آخر تفتيش:</h4>
                <div><strong>تاريخ التفتيش: </strong><span>${record.latest_Inspectiondate || 'لا يوجد تاريخ'}</span></div>
                <div><strong>الإجراء: </strong><span>${record.latest_Action || 'لا يوجد إجراء'}</span></div>
                <div><strong>نوع التفتيش: </strong><span>${record.latest_InspectionType || 'غير محدد'}</span></div>
                <div><strong>درجة التقييم: </strong><span>${record.latest_EvaluationResult || 'غير محدد'}</span></div>
                <div><strong>مدة التحذير: </strong><span>${record.latest_WarningPeriod || 'غير محدد'}</span></div>
                <div><strong>ملاحظات: </strong><span>${record.latest_Notes || 'لا يوجد ملاحظات'}</span></div>
                <div><strong>رقم المفتش: </strong><span>${record.latest_InspectorID || 'غير محدد'}</span></div>
            `;
            $('#info-details-container').html(infoHtml);
            $('#whatsapp-btn').off('click').on('click', () => sendWhatsApp(record.facility_ID));
            $('#email-btn').off('click').on('click', () => sendEmail(record.facility_ID));
            $('#location-btn').off('click').on('click', () => openLocation(record.facility_ID));
            $('#edit-data-btn').off('click').on('click', () => openEditEstablishmentForm(record.facility_unq_id));
            $('#add-inspection-btn').off('click').on('click', () => openAddEditInspectionForm(record.facility_unq_id));
            $('#delete-establishment-btn').off('click').on('click', () => deleteEstablishment(record.facility_unq_id));
            $.getJSON('get_inspections.php?facility_unq_id=' + record.facility_unq_id, function(data) {
                if(data.success && data.data && data.data.length) {
                    let year = (new Date).getFullYear()+'';
                    let visits = data.data.filter(x => x.date && x.date.startsWith(year));
                    let html = '<h5 style="font-size:13px; color:var(--accent-blue);">زيارات هذا العام:</h5><ul style="padding-right:20px; margin-top:5px; list-style-type: disc;">';
                    visits.forEach(v => html += `<li>${v.date} - ${v.action || ''}</li>`);
                    html += '</ul>';
                    $('#previous-inspections').html(html);
                } else {
                    $('#previous-inspections').html('<div style="font-size:13px; color:#666;">لا توجد زيارات خلال العام الحالي.</div>');
                }
            });
        }
        function filterPoints() {
            console.log("filterPoints called."); // Debug log
            var selectedActions = Array.from(document.querySelectorAll('#action-filters input[type="checkbox"].action-filter:checked')).map(cb => cb.value);
            var selectedActivities = Array.from(document.querySelectorAll('#activity-filters input[type="checkbox"].activity-filter:checked')).map(cb => cb.value);
            var selectedLicenseIssuing = Array.from(document.querySelectorAll('#license-issuing-filters input[type="checkbox"].license-issuing-filter:checked')).map(cb => cb.value);
            var selectedLtype = Array.from(document.querySelectorAll('#ltype-filters input[type="checkbox"].ltype-filter:checked')).map(cb => cb.value);
            var selectedFacilityStatus = Array.from(document.querySelectorAll('#facility-status-filters input[type="checkbox"].facility-status-filter:checked')).map(cb => cb.value);
            var selectedUnit = Array.from(document.querySelectorAll('#unit-filters input[type="checkbox"].unit-filter:checked')).map(cb => cb.value);
            var selectedShjhsp = Array.from(document.querySelectorAll('#shjhsp-filters input[type="checkbox"].shjhsp-filter:checked')).map(cb => cb.value);
            var selectedHazardClass = Array.from(document.querySelectorAll('#hazard-class-filters input[type="checkbox"].hazard-class-filter:checked')).map(cb => cb.value);
            var searchText = $('#main-search-box').val() ? $('#main-search-box').val().toLowerCase() : '';
            const {from, to} = getDateRangeFilterValues();
            const showAllFacilities = $('#show-all-facilities').is(':checked');

            console.log("Filtering points with:");
            console.log("  Selected Actions:", selectedActions);
            console.log("  Selected Activities:", selectedActivities);
            console.log("  Search Text:", searchText);
            console.log("  Date Range:", from, to);
            console.log("  Show All Facilities:", showAllFacilities);

            var filteredPoints = allRecords.filter(function(point) {
                var actionMatch = selectedActions.length === 0 ||
                    (point.latest_Action && selectedActions.some(selAction => point.latest_Action.split(',').map(a=>a.trim()).includes(selAction)));
                var activityMatch = selectedActivities.length === 0 ||
                    (point.activity_type && selectedActivities.includes(point.activity_type));
                var licenseIssuingMatch = selectedLicenseIssuing.length === 0 ||
                    (point.LicenseIssuing && selectedLicenseIssuing.includes(point.LicenseIssuing));
                var ltypeMatch = selectedLtype.length === 0 ||
                    (point.ltype && selectedLtype.includes(point.ltype));
                var facilityStatusMatch = selectedFacilityStatus.length === 0 ||
                    (point.facility_status && selectedFacilityStatus.includes(point.facility_status));
                var unitMatch = selectedUnit.length === 0 ||
                    (point.unit && selectedUnit.includes(point.unit));
                var shjhspMatch = selectedShjhsp.length === 0 ||
                    (point.shjhsp && selectedShjhsp.includes(point.shjhsp));
                var hazardClassMatch = selectedHazardClass.length === 0 ||
                    (point.hazard_class && selectedHazardClass.includes(point.hazard_class));
                var searchMatch = searchText === '' ||
                    (point.license_no && String(point.license_no).toLowerCase().includes(searchText)) ||
                    (point.facility_name && point.facility_name.toLowerCase().includes(searchText));
                let inspectionDate = point.latest_Inspectiondate || '';
                let inDateRange = true;
                if(from) inDateRange = inspectionDate >= from;
                if(to && inDateRange) inDateRange = inspectionDate <= to;
                let isInspected = !!inspectionDate;
                let facilityMatch = showAllFacilities ? true : isInspected;

                // console.log(`  Point ${point.facility_name}: Action Match: ${actionMatch}, Activity Match: ${activityMatch}, Search Match: ${searchMatch}, Date Range Match: ${inDateRange}, Facility Match: ${facilityMatch}`);

                return actionMatch && activityMatch && licenseIssuingMatch && ltypeMatch &&
                facilityStatusMatch && unitMatch && shjhspMatch && hazardClassMatch && searchMatch && inDateRange && facilityMatch;
            });
            renderPoints(filteredPoints);
            reFilterAll(); // Re-render filters based on currently *displayed* points counts
            console.log("filterPoints finished."); // Debug log
        }
        function fetchAndRenderPoints() {
            console.log("fetchAndRenderPoints called. Attempting to fetch data from get_map_data.php"); // Debug log
            fetch('get_map_data.php')
            .then(response => {
                console.log("Response received from get_map_data.php. Status:", response.status); // Debug log
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Data successfully parsed:", data); // Debug log
                if (data.success) {
                    allRecords = data.data;
                    console.log("Total records loaded:", allRecords.length); // Debug log
                    renderPoints(allRecords);
                    reFilterAll();
                } else {
                    showNotification('فشل جلب بيانات الخريطة: ' + (data.msg || 'خطأ غير معروف'), 'error');
                    console.error("Failed to fetch map data:", data.msg); // Debug log
                }
            })
            .catch(error => {
                showNotification('خطأ في الاتصال بالخادم لجلب بيانات الخريطة: ' + error.message, 'error');
                console.error("Fetch error for get_map_data.php:", error); // Debug log
            });
        }
        function getDateRangeFilterValues() {
            let from = $('#inspection-date-from').val();
            let to = $('#inspection-date-to').val();
            return {from, to};
        }
        function getUniqueFilteredSet(field) {
            let values = new Set();
            filteredRecords.forEach(record => {
                if (field === 'latest_Action' && record.latest_Action) {
                    record.latest_Action.split(',').map(a => a.trim()).forEach(action => values.add(action));
                }
                else if (record[field]) values.add(record[field]);
            });
            return values;
        }
        function createFilterCheckboxes(containerId, valuesSet, className, dataField = null, colorFunction = null) {
            console.log("createFilterCheckboxes called for:", containerId); // Debug log
            const container = document.getElementById(containerId);
            // Capture currently checked values BEFORE clearing the container
            const checkedValues = Array.from(container.querySelectorAll(`input[type="checkbox"].${className}:checked`)).map(cb => cb.value);
            
            container.innerHTML = ''; // Clear container

            // Add "Select All" checkbox
            const selectAllLabel = document.createElement('label');
            const selectAllCheckbox = document.createElement('input');
            selectAllCheckbox.type = 'checkbox';
            selectAllCheckbox.className = 'select-all-filter';
            selectAllCheckbox.value = 'all';
            // Set initial state of "Select All" based on previously checked items
            selectAllCheckbox.checked = (checkedValues.length > 0 && checkedValues.length === Array.from(valuesSet).length) || (checkedValues.length === 0 && valuesSet.size === 0);

            selectAllCheckbox.onchange = function() {
                console.log("Select All checkbox changed for", containerId, "to:", this.checked); // Debug log
                const checkboxes = container.querySelectorAll(`.${className}`);
                checkboxes.forEach(cb => { cb.checked = this.checked; });
                filterPoints(); // Trigger filter after selecting/deselecting all
            };
            selectAllLabel.appendChild(selectAllCheckbox);
            selectAllLabel.appendChild(document.createTextNode('تحديد الكل'));
            container.appendChild(selectAllLabel);

            const counts = {};
            filteredRecords.forEach(record => {
                if (dataField === 'latest_Action' && record.latest_Action) {
                    record.latest_Action.split(',').map(a => a.trim()).forEach(action => {
                        counts[action] = (counts[action] || 0) + 1;
                    });
                } else if (record[dataField]) {
                    counts[record[dataField]] = (counts[record[dataField]] || 0) + 1;
                }
            });
            
            // Add individual filter options
            Array.from(valuesSet).sort().forEach(value => {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = className;
                checkbox.value = value;
                // Restore checked state for individual checkboxes
                if (checkedValues.includes(value)) checkbox.checked = true;
                
                label.appendChild(checkbox);
                if (colorFunction) {
                    const colorDot = document.createElement('span');
                    colorDot.className = 'color-dot';
                    colorDot.style.backgroundColor = colorFunction(value);
                    label.appendChild(colorDot);
                }
                const count = counts[value] || 0;
                label.appendChild(document.createTextNode(`${value} (${count})`));
                container.appendChild(label);
            });
            // Attach a single delegated event listener for all checkboxes in this container
            $('#' + containerId).off('change').on('change', `.${className}`, function() {
                console.log("Individual filter checkbox changed for", containerId, "value:", this.value, "checked:", this.checked); // Debug log
                filterPoints(); // Trigger filter when any individual checkbox changes
                const allSpecificCheckboxes = document.querySelectorAll(`#${containerId} .${className}`);
                const checkedSpecificCheckboxes = document.querySelectorAll(`#${containerId} .${className}:checked`);
                const selectAllCheckbox = document.querySelector(`#${containerId} .select-all-filter`);
                if (allSpecificCheckboxes.length > 0 && checkedSpecificCheckboxes.length === allSpecificCheckboxes.length) {
                    selectAllCheckbox.checked = true;
                } else {
                    selectAllCheckbox.checked = false;
                }
            });
        }
        function reFilterAll() {
            console.log("reFilterAll called."); // Debug log
            createFilterCheckboxes('action-filters', getUniqueFilteredSet('latest_Action'), 'action-filter', 'latest_Action', getActionColor);
            createFilterCheckboxes('activity-filters', getUniqueFilteredSet('activity_type'), 'activity-filter', 'activity_type', getActivityColor);
            createFilterCheckboxes('license-issuing-filters', getUniqueFilteredSet('LicenseIssuing'), 'license-issuing-filter', 'LicenseIssuing');
            createFilterCheckboxes('ltype-filters', getUniqueFilteredSet('ltype'), 'ltype-filter', 'ltype');
            createFilterCheckboxes('facility-status-filters', getUniqueFilteredSet('facility_status'), 'facility-status-filter', 'facility_status');
            createFilterCheckboxes('unit-filters', getUniqueFilteredSet('unit'), 'unit-filter', 'unit');
            createFilterCheckboxes('shjhsp-filters', getUniqueFilteredSet('shjhsp'), 'shjhsp-filter', 'shjhsp');
            createFilterCheckboxes('hazard-class-filters', getUniqueFilteredSet('hazard_class'), 'hazard-class-filter', 'hazard_class');
        }
        function renderCharts() {
            console.log("renderCharts called."); // Debug log
            $('#charts-container').empty();
            const filters = [
                { key: 'activity_type', label: 'الأنشطة' },
                { key: 'area', label: 'المناطق' },
                { key: 'LicenseIssuing', label: 'جهة الإصدار' },
                { key: 'ltype', label: 'نوع الرخصة' },
                { key: 'facility_status', label: 'حالة المنشأة' },
                { key: 'unit', label: 'الوحدة' },
                { key: 'shjhsp', label: 'SHJHSP' },
                { key: 'hazard_class', label: 'درجة الخطورة' }
            ];
            filters.forEach(f => {
                let dataMap = {};
                filteredRecords.forEach(rec => {
                    const fval = rec[f.key] || 'غير محدد';
                    if (!dataMap[fval]) dataMap[fval] = {};
                    if (rec.latest_Action) {
                        rec.latest_Action.split(',').map(a=>a.trim()).forEach(action => {
                            dataMap[fval][action] = (dataMap[fval][action]||0)+1;
                        });
                    }
                });
                let labels = Object.keys(dataMap);
                let actionTypes = Array.from(new Set([].concat(...labels.map(l => Object.keys(dataMap[l])))));
                let datasets = actionTypes.map(act => ({
                    label: act,
                    backgroundColor: colorForAction(act),
                    data: labels.map(l => dataMap[l][act]||0)
                }));
                let chartId = `${f.key}Chart`;
                $('#charts-container').append(`
                    <div style="margin-bottom: 25px;">
                        <h4 style="font-size:14px; margin-bottom:12px; border-bottom: 1px solid #eee; padding-bottom: 8px;">توزيع الإجراءات حسب ${f.label}</h4>
                        <canvas id="${chartId}" style="height: 200px; width: 100%;"></canvas>
                    </div>
                `);
                let ctx = document.getElementById(chartId).getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top', labels: { font: { size: 12, family: 'Cairo' } } },
                            datalabels: {
                                display: true,
                                color: '#222',
                                font: {weight:'bold',size:10, family: 'Cairo'},
                                anchor: 'end',
                                align: 'top',
                                formatter: (value, ctx) => value > 0 ? value : ''
                            }
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { font: { size: 11, family: 'Cairo' }, color: '#555'} },
                            x: { ticks: { font: { size: 10, family: 'Cairo' }, color: '#555'} }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            });
            console.log("Charts rendered."); // Debug log
        }
        function printChartReport() {
            console.log("printChartReport called."); // Debug log
            let w = window.open('', '', 'width=900,height=900');
            w.document.write('<style>@import url("https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap"); body { font-family: "Cairo", sans-serif; direction: rtl; }</style>');
            w.document.write('<h2 style="font-size:20px; text-align: center; color:var(--accent-blue); margin-top: 20px;">تقرير الرسوم البيانية للمنشآت</h2>');
            $('#charts-container canvas').each(function(){
                w.document.write('<div style="margin-bottom:30px; page-break-inside: avoid;"><img src="' + this.toDataURL() + '" style="max-width:95vw; border: 1px solid #ddd; padding: 5px; background: #fff;"/></div>');
            });
            setTimeout(()=>{
                console.log("Calling window.print() for chart report."); // Debug log
                w.print();
            }, 400);
        }
        function printAllFilteredRecords() {
            console.log("printAllFilteredRecords called."); // Debug log
            if (!filteredRecords.length) {
                showNotification("لا توجد بيانات (مفلترة) للطباعة.", 'error');
                console.warn("No filtered records to print."); // Debug log
                return;
            }
            let printContent = `
                <div class="report-header">
                    <img src="shjmunlogo.png" alt="شعار بلدية الشارقة" />
                    <div>
                        <div class="report-title">قسم الرقابة الصحية - تقرير بيانات المنشآت</div>
                        <div style="font-size:14px;color:#666;">عدد المنشآت: <b>${filteredRecords.length}</b></div>
                        <div style="font-size:11px;color:#444;">تاريخ التقرير: ${new Date().toLocaleDateString('ar-AE')}</div>
                    </div>
                </div>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>اسم المنشأة</th>
                            <th>المنطقة</th>
                            <th>النشاط</th>
                            <th>الإجراء</th>
                            <th>تاريخ آخر تفتيش</th>
                            <th>رقم الرخصة</th>
                            <th>جهة الإصدار</th>
                            <th>نوع الرخصة</th>
                            <th>حالة المنشأة</th>
                            <th>الوحدة</th>
                            <th>SHJHSP</th>
                            <th>درجة الخطورة</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            filteredRecords.forEach((record, index) => {
                // لون الإجراء حسب الأولوية
                let bgAction = getActionColor(record.latest_Action);
                printContent += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${record.facility_name || ''}</td>
                        <td>${record.area || ''}</td>
                        <td>${record.activity_type || ''}</td>
                        <td style="background:${bgAction};color:#fff;font-weight:bold;">${record.latest_Action || ''}</td>
                        <td>${record.latest_Inspectiondate || ''}</td>
                        <td>${record.license_no || ''}</td>
                        <td>${record.LicenseIssuing || ''}</td>
                        <td>${record.ltype || ''}</td>
                        <td>${record.facility_status || ''}</td>
                        <td>${record.unit || ''}</td>
                        <td>${record.shjhsp || ''}</td>
                        <td>${record.hazard_class || ''}</td>
                    </tr>
                `;
            });
            printContent += '</tbody></table>';
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = printContent;
            console.log("Generated print content and set to print-area."); // Debug log
            window.print();
            console.log("window.print() called for data report."); // Debug log
        }
        function sendWhatsApp(recordId) {
            console.log("sendWhatsApp called for ID:", recordId); // Debug log
            const record = allRecords.find(r => r.facility_ID == recordId);
            if (!record) {
                showNotification('لم يتم العثور على السجل لإرساله عبر واتساب.', 'error');
                return;
            }
            const coords = record.site_coordinates ? record.site_coordinates.split(',').map(Number) : [null, null];
            const googleMapsLink = (coords[0] && coords[1]) ? `https://www.google.com/maps/search/?api=1&query=$${coords[0]},${coords[1]}` : 'لا يوجد إحداثيات';
            const text = encodeURIComponent(`
*تفاصيل المنشأة:*
- *الاسم:* ${record.facility_name || 'غير متوفر'}
- *الرخصة:* ${record.license_no || 'غير متوفر'}
- *المنطقة:* ${record.area || 'غير متوفر'}
- *النشاط:* ${record.activity_type || 'غير متوفر'}
- *آخر إجراء:* ${record.latest_Action || 'لا يوجد'}
- *رابط الموقع:* ${googleMapsLink}
`);
            window.open(`https://wa.me/?text=${text}`, '_blank');
            showNotification('تم فتح تطبيق واتساب لمشاركة البيانات.', 'success');
        }
        function sendEmail(recordId) {
            console.log("sendEmail called for ID:", recordId); // Debug log
            const record = allRecords.find(r => r.facility_ID == recordId);
            if (!record) { showNotification('لم يتم العثور على السجل لإرساله عبر البريد الإلكتروني.', 'error'); return; }
            const subject = encodeURIComponent(`معلومات منشأة: ${record.facility_name || 'غير متوفر'}`);
            const coords = record.site_coordinates ? record.site_coordinates.split(',').map(Number) : [null, null];
            const googleMapsLink = (coords[0] && coords[1]) ? `https://www.google.com/maps/search/?api=1&query=$${coords[0]},${coords[1]}` : 'لا يوجد إحداثيات';
            const body = encodeURIComponent(`
*تفاصيل المنشأة:*
- *الاسم:* ${record.facility_name || 'غير متوفر'}
- *الرخصة:* ${record.license_no || 'غير متوفر'}
- *المنطقة:* ${record.area || 'غير متوفر'}
- *النشاط:* ${record.activity_type || 'غير متوفر'}
- *آخر إجراء:* ${record.latest_Action || 'لا يوجد'}
- *رابط الموقع:* ${googleMapsLink}
`);
            window.open(`mailto:?subject=${subject}&body=${body}`, '_blank');
            showNotification('تم فتح تطبيق البريد الإلكتروني لمشاركة البيانات.', 'success');
        }
        function openLocation(recordId) {
            console.log("openLocation called for ID:", recordId); // Debug log
            const record = allRecords.find(r => r.facility_ID == recordId);
            if (!record || !record.site_coordinates) {
                showNotification('لا توجد إحداثيات متاحة لهذه المنشأة.', 'error');
                return;
            }
            const coords = record.site_coordinates.split(',').map(Number);
            if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                const url = `https://www.google.com/maps/search/?api=1&query=$${coords[0]},${coords[1]}`;
                window.open(url, '_blank');
                showNotification('تم فتح الموقع الجغرافي في خرائط جوجل.', 'success');
            } else {
                showNotification('الإحداثيات غير صالحة لهذه المنشأة.', 'error');
            }
        }
        function exportExcel() {
            console.log("exportExcel called."); // Debug log
            if (!filteredRecords.length) {
                showNotification("لا توجد بيانات (مفلترة) للتصدير!", 'error');
                console.warn("No filtered records to export."); // Debug log
                return;
            }
            const headers = [
                "ID", "رقم الرخصة", "جهة الإصدار", "نوع الرخصة", "Sub No", "Unique ID",
                "اسم المنشأة", "المنطقة", "النشاط", "الأنشطة التفصيلية", "حالة المنشأة",
                "الوحدة", "SHJHSP", "درجة الخطورة", "الإحداثيات", "العلامة التجارية",
                "تاريخ بداية الرخصة", "تاريخ انتهاء الرخصة", "المستخدم", "حالة المنشأة (Status)",
                "تاريخ آخر تفتيش", "الإجراء", "نوع التفتيش", "درجة التقييم",
                "مدة التحذير", "ملاحظات", "رقم المفتش"
            ];
            const data = filteredRecords.map(record => [
                record.facility_ID,
                record.license_no,
                record.LicenseIssuing,
                record.ltype,
                record.sub_no,
                record.facility_unq_id,
                record.facility_name,
                record.area,
                record.activity_type,
                record.detailed_activities,
                record.facility_status,
                record.unit,
                record.shjhsp,
                record.hazard_class,
                record.site_coordinates,
                record.brand_name,
                record.lstart_date,
                record.lend_date,
                record.user,
                record.status,
                record.latest_Inspectiondate,
                record.latest_Action,
                record.latest_InspectionType,
                record.latest_EvaluationResult,
                record.latest_WarningPeriod,
                record.latest_Notes,
                record.latest_InspectorID
            ]);
            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "بيانات_المنشآت_المفلترة");
            XLSX.writeFile(wb, "بيانات_المنشآت_المفلترة.xlsx");
            showNotification('تم تصدير البيانات بنجاح إلى ملف Excel.', 'success');
            console.log("Data exported to Excel."); // Debug log
        }
        function openNewEstablishmentForm() {
            console.log("openNewEstablishmentForm called."); // Debug log
            window.open('form_establishment.html', '_blank');
            showNotification('جارٍ فتح نموذج إضافة منشأة جديدة.', 'info');
        }
        function openEditEstablishmentForm(unique_id) {
            console.log("openEditEstablishmentForm called for ID:", unique_id); // Debug log
            window.open(`form_establishment.html?unique_id=${unique_id}`, '_blank');
            showNotification('جارٍ فتح نموذج تعديل بيانات المنشأة.', 'info');
        }
        function openAddEditInspectionForm(unique_id) {
            console.log("openAddEditInspectionForm called for ID:", unique_id); // Debug log
            window.open(`inspection_form.html?facility_unq_id=${unique_id}`, '_blank');
            showNotification('جارٍ فتح نموذج إضافة/تعديل زيارة تفتيش.', 'info');
        }
        function deleteEstablishment(unique_id) {
            console.log("deleteEstablishment called for ID:", unique_id); // Debug log
            if (!confirm('هل أنت متأكد من حذف المنشأة؟ لا يمكن التراجع عن هذا الإجراء.')) return;
            allRecords = allRecords.filter(r => r.facility_unq_id != unique_id);
            filterPoints();
            $('#info').hide();
            showNotification('تم حذف المنشأة بنجاح.', 'success');
            console.log("Establishment deleted from local records."); // Debug log
            // In a real application, you would also send a request to a backend to delete the record from the database.
        }

        // Notification function (non-interactive)
        function showNotification(message, type = 'info', duration = 3000) {
            console.log(`Displaying notification: Type: ${type}, Message: ${message}`); // Debug log
            const notification = $('#notification-popup');
            notification.empty(); // Clear content for non-interactive
            notification.text(message);
            notification.removeClass('success error info').addClass(type).addClass('show');
            setTimeout(() => {
                notification.removeClass('show');
            }, duration);
        }

        // Interactive Notification function
        function showInteractiveNotification(message, confirmCallback, cancelCallback = null, duration = 15000) { // Increased duration for interactive
            console.log("Displaying interactive notification."); // Debug log
            const notification = $('#notification-popup');
            notification.empty(); // Clear previous content
            notification.append(`<div style="margin-bottom: 10px;">${message}</div>`);

            const buttonContainer = $('<div style="display: flex; justify-content: center; gap: 10px;"></div>');
            const confirmBtn = $('<button style="background-color: var(--primary-green); color: var(--text-light); border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">متابعة</button>');
            const cancelBtn = $('<button style="background-color: #6c757d; color: var(--text-light); border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">إلغاء</button>');

            confirmBtn.on('click', () => {
                console.log("Interactive notification: Confirm clicked."); // Debug log
                notification.removeClass('show');
                if (confirmCallback) confirmCallback();
            });

            cancelBtn.on('click', () => {
                console.log("Interactive notification: Cancel clicked."); // Debug log
                notification.removeClass('show');
                if (cancelCallback) cancelCallback();
            });

            buttonContainer.append(confirmBtn);
            buttonContainer.append(cancelBtn); 
            notification.append(buttonContainer);

            notification.removeClass('success error info').addClass('info').addClass('show');
            
            // Auto-dismiss after duration if no interaction
            setTimeout(() => {
                if (notification.hasClass('show')) {
                    console.log("Interactive notification auto-dismissed."); // Debug log
                    notification.removeClass('show');
                }
            }, duration);
        }

        // Function to request notification permission
        function requestNotificationPermission() {
            console.log("requestNotificationPermission called."); // Debug log
            if (!("Notification" in window)) {
                console.warn("This browser does not support desktop notification");
                showNotification('متصفحك لا يدعم الإشعارات.', 'error');
            } else if (Notification.permission === "granted") {
                console.log("Notification permission already granted.");
                // No need to show notification, just log
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(function (permission) {
                    if (permission === "granted") {
                        showNotification('تم منح إذن الإشعارات بنجاح.', 'success');
                        console.log("Notification permission granted by user."); // Debug log
                    } else {
                        showNotification('تم رفض إذن الإشعارات.', 'error');
                        console.log("Notification permission denied by user."); // Debug log
                    }
                });
            } else {
                showNotification('إذن الإشعارات ممنوع. يرجى تفعيله يدويًا من إعدادات المتصفح.', 'error', 5000);
                console.warn("Notification permission is denied and needs manual intervention."); // Debug log
            }
        }

        // Helper function to add days to a date string (YYYY-MM-DD)
        function addDaysToDate(dateString, days) {
            if (!dateString) return null;
            const date = new Date(dateString + 'T00:00:00'); // Use T00:00:00 to avoid timezone issues
            date.setDate(date.getDate() + days);
            return date.toISOString().split('T')[0]; // Format back toYYYY-MM-DD
        }

        // Function to check nearby warnings based on WarningPeriod expiration
        function checkNearbyWarnings() {
            console.log("checkNearbyWarnings called."); // Debug log
            if (Notification.permission !== "granted") {
                showNotification('يرجى تمكين إشعارات المتصفح أولاً للتحقق من التحذيرات.', 'error', 5000);
                requestNotificationPermission(); // Prompt for permission again
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day for comparison
            let foundWarningThisRun = false;

            filteredRecords.forEach(point => {
                const inspectionDateStr = point.latest_Inspectiondate;
                const warningPeriod = parseInt(point.latest_WarningPeriod);

                // Check if the point has an 'انذار' (warning) action
                const actions = point.latest_Action ? point.latest_Action.split(',').map(a => a.trim()) : [];
                
                // Proceed only if it's an 'انذار', has an inspection date, and a valid warning period
                if (actions.includes('انذار') && inspectionDateStr && !isNaN(warningPeriod)) {
                    const triggerDateStr = addDaysToDate(inspectionDateStr, warningPeriod);
                    const triggerDate = new Date(triggerDateStr + 'T00:00:00'); // Ensure triggerDate is also start of day
                    
                    console.log(`--- Checking Facility: ${point.facility_name} ---`);
                    console.log(`  Inspection Date: ${inspectionDateStr}`);
                    console.log(`  Warning Period: ${warningPeriod} days`);
                    console.log(`  Calculated Trigger Date (str): ${triggerDateStr}`);
                    console.log(`  Calculated Trigger Date (ms): ${triggerDate.getTime()}`);
                    console.log(`  Today (ms): ${today.getTime()}`);
                    console.log(`  Is today >= trigger date? : ${today.getTime() >= triggerDate.getTime()}`);
                    console.log(`  Already notified? : ${notified.has(point.facility_unq_id)}`);
                    console.log(`  Condition met (today >= trigger && !notified)? : ${today.getTime() >= triggerDate.getTime() && !notified.has(point.facility_unq_id)}`);

                    if (today.getTime() >= triggerDate.getTime() && !notified.has(point.facility_unq_id)) {
                        foundWarningThisRun = true;
                        const msg = `
📍 الاسم: ${point.facility_name || 'غير متوفر'}
📍 المنطقة: ${point.area || 'غير متوفر'}
📄 الرخصة: ${point.license_no || 'غير متوفر'}
📅 تاريخ آخر زيارة: ${inspectionDateStr || 'غير متوفر'}
⚠️ انتهت فترة التحذير (${warningPeriod} أيام).
                        `;
                        
                        showInteractiveNotification(msg + "<br>هل ترغب بالمتابعة الآن؟",
                            () => { // Confirm callback
                                if (point.site_coordinates) {
                                    const coords = point.site_coordinates.split(',').map(Number);
                                    if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                                        const mapUrl = `https://www.google.com/maps/search/?api=1&query=$${coords[0]},${coords[1]}`;
                                        window.open(mapUrl, '_blank');
                                        showNotification('تم فتح خرائط جوجل للمتابعة.', 'success');
                                    } else {
                                        showNotification('الإحداثيات غير صالحة لهذه المنشأة.', 'error');
                                    }
                                } else {
                                    showNotification('لا توجد إحداثيات متاحة لهذه المنشأة.', 'error');
                                }
                            },
                            () => { // Cancel callback
                                showNotification('تم إلغاء المتابعة.', 'info');
                            }
                        );
                        notified.add(point.facility_unq_id); // Add to set to prevent repeat notifications for same facility
                    }
                }
            });

            if (!foundWarningThisRun) {
                showNotification('لا توجد تحذيرات جديدة انتهت مدتها.', 'info');
            }
            console.log("checkNearbyWarnings finished."); // Debug log
        }

        // Keeping these functions as they might be used elsewhere or for future features,
        // even though checkNearbyWarnings no longer uses them for its primary logic.
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // metres
            const φ1 = lat1 * Math.PI / 180; // φ, λ in radians
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // in meters
        }

        function getDrivingTimeInMinutes(distanceMeters) {
            const mode = document.getElementById("mode").value;
            let speedMetersPerMinute;

            if (mode === 'car') {
                const now = new Date();
                const hour = now.getHours();
                const minute = now.getMinutes();
                const currentTimeInMinutes = hour * 60 + minute;

                const isRushHour =
                    (currentTimeInMinutes >= 7 * 60 && currentTimeInMinutes <= 10 * 60) ||   // 7:00 AM to 10:00 AM
                    (currentTimeInMinutes >= 14.5 * 60 && currentTimeInMinutes <= 22 * 60);   // 2:30 PM to 10:00 PM

                speedMetersPerMinute = isRushHour ? 166.67 : 333.33; // 10 km/h or 20 km/h
            } else {
                speedMetersPerMinute = 83.33; // Walking speed: 5 km/h
            }

            return distanceMeters / speedMetersPerMinute; // in minutes
        }

        $(document).ready(function() {
            console.log("Document ready. Initializing..."); // Debug log
            fetchAndRenderPoints();
            $('#main-search-box').on('input', filterPoints);
            $('#inspection-date-from, #inspection-date-to, #show-all-facilities').on('change', filterPoints);
            $('.filter-content').hide();
            $('#charts-panel, #controls, #info').hide(); // Ensure all panels are hidden by default
            console.log("Initial panel states set to hidden."); // Debug log

            // Toggle buttons for panels using the unified showPanel function
            $("#toggleControlsBtn").click(function(){
                console.log("toggleControlsBtn clicked."); // Debug log
                showPanel('controls');
            });
            $("#toggleChartsBtn").click(function(){
                console.log("toggleChartsBtn clicked."); // Debug log
                renderCharts(); // Render charts always before showing the panel
                showPanel('charts-panel');
            });
            $("#toggleInfoBtn").click(function(){
                console.log("toggleInfoBtn clicked."); // Debug log
                showPanel('info');
            });
            console.log("Event listeners bound for main controls and filters."); // Debug log
        });
    </script>
</body>
</html>
