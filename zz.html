<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>تنبيهات قريبة</title>
</head>
<body>
    <select id="mode">
        <option value="car">🚗 سيارة</option>
        <option value="walk">🚶‍♂️ مشي</option>
    </select>

<script>
var alertAudio = new Audio('https://www.soundjay.com/button/beep-07.wav');

// طلب إذن الإشعارات
if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission();
}

// حساب المسافة
function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const φ1 = lat1 * Math.PI / 180;
    const φ2 = lat2 * Math.PI / 180;
    const Δφ = (lat2 - lat1) * Math.PI / 180;
    const Δλ = (lon2 - lon1) * Math.PI / 180;

    const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
              Math.cos(φ1) * Math.cos(φ2) *
              Math.sin(Δλ/2) * Math.sin(Δλ/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// الزمن حسب الوضع والزحام
function getDrivingTimeInMinutes(distanceMeters) {
    const mode = document.getElementById("mode").value;
    let speedKph;

    if (mode === 'walk') {
        speedKph = 5;
    } else {
        const now = new Date();
        const totalMinutes = now.getHours() * 60 + now.getMinutes();

        if (totalMinutes >= 360 && totalMinutes < 450) {
            speedKph = 10; // 6:00 - 7:30
        } else if (totalMinutes >= 450 && totalMinutes < 570) {
            speedKph = 5;  // 7:30 - 9:30
        } else if (totalMinutes >= 570 && totalMinutes < 840) {
            speedKph = 15; // 9:30 - 14:00
        } else if (totalMinutes >= 840 && totalMinutes < 1020) {
            speedKph = 8;  // 14:00 - 17:00
        } else if (totalMinutes >= 1020 && totalMinutes < 1320) {
            speedKph = 5;  // 17:00 - 22:00
        } else {
            speedKph = 20; // بعد 10 مساءً
        }
    }

    const speedMetersPerMinute = (speedKph * 1000) / 60;
    return distanceMeters / speedMetersPerMinute;
}

// عرض الإشعار
function showNotification(point, time) {
    const msg = `
📍 الاسم: ${point.fname}
📍 المنطقة: ${point.area}
📄 الرخصة: ${point.lic}
🏢 القطاع: ${point.sector}
📅 آخر زيارة: ${point.Fdate}
⏳ الزمن المتوقع للوصول: ${Math.round(time)} دقيقة
    `;
    alertAudio.play();

    if ("Notification" in window && Notification.permission === "granted") {
        const notification = new Notification("🚨 تنبيه قريب", {
            body: msg,
            icon: "https://cdn-icons-png.flaticon.com/512/565/565547.png"
        });

        notification.onclick = () => {
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${point.latitude},${point.longitude}`, '_blank');
        };
    }

    const confirmReview = confirm(msg + "\nهل ترغب بالمراجعة الآن؟");
    if (confirmReview) {
        window.open(`https://www.google.com/maps/dir/?api=1&destination=${point.latitude},${point.longitude}`, '_blank');
    }
}

// نقاط التجربة (مثال فقط)
const pointsData = [
    {
        fname: "مطعم الدانة",
        area: "الناصرية",
        lic: "123456",
        sector: "مطاعم",
        Fdate: "2025-04-20",
        latitude: 25.3621,
        longitude: 55.3912,
        action: "انذار"
    }
];

let notified = new Set();

function checkNearbyWarnings() {
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(pos => {
        const userLat = pos.coords.latitude;
        const userLon = pos.coords.longitude;

        pointsData.forEach(point => {
            if (point.action === 'انذار') {
                const distance = getDistance(userLat, userLon, point.latitude, point.longitude);
                const time = getDrivingTimeInMinutes(distance);
                if (time <= 5 && !notified.has(point.fname)) {
                    showNotification(point, time);
                    notified.add(point.fname);
                }
            }
        });
    });
}

// تحقق كل 30 ثانية
setInterval(checkNearbyWarnings, 30000);

// تغيير الوضع يعيد الفحص
document.getElementById("mode").addEventListener("change", () => {
    notified.clear();
    checkNearbyWarnings();
});
</script>
</body>
</html>
