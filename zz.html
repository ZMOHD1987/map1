<!DOCTYPE html>
<html lang='ar' dir='rtl'>
<head>
    <meta charset='utf-8'>
    <title>Sharjah Municipality Food Control Section Map</title>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <link rel='stylesheet' href='https://unpkg.com/leaflet@1.7.1/dist/leaflet.css' />
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css' />
    <style>
        :root {
            --primary-color: #2e7d32;
            --primary-light: #4caf50;
            --primary-dark: #1b5e20;
            --secondary-color: #ff9800;
            --danger-color: #f44336;
            --info-color: #2196f3;
            --warning-color: #ffc107;
            --success-color: #4caf50;
            --light-gray: #f5f5f5;
            --medium-gray: #e0e0e0;
            --dark-gray: #757575;
            --text-color: #333;
            --text-light: #f5f5f5;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        body { 
            font-family: 'Tajawal', 'Arial', sans-serif; 
            margin: 0; 
            padding: 0; 
            overflow: hidden;
            background-color: #f4f4f4;
            direction: rtl;
        }
        #map { 
            height: 100vh; 
            width: 100%; 
        }

        #controls, #info { 
            position: absolute; 
            z-index: 400; 
            background-color: rgba(255, 255, 255, 0.95); 
            border-radius: 12px; 
            padding: 15px;
            box-shadow: var(--shadow); 
            font-size: 14px;
            color: var(--text-color);
            transition: var(--transition); 
            max-height: calc(100vh - 20px); 
            overflow-y: auto; 
            box-sizing: border-box;
            border: 1px solid var(--medium-gray);
        }
        #controls { 
            top: 10px; 
            left: 60px;
            width: 280px;
        }
        #info { 
            top: 10px; 
            right: 10px;
            width: 300px;
        }
        
        .panel-hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transform: translateY(10px);
        }
        .hidden {
            display: none !important;
        }

        #logo { 
            position: absolute; 
            top: 10px; 
            z-index: 500; 
            width: 50px; 
            height: 50px;
            border-radius: 50%; 
            box-shadow: var(--shadow);
            left: 10px;
            border: 2px solid white;
        }
        
        #toggle-controls-btn, #toggle-info-btn {
            position: absolute;
            z-index: 500;
            background-color: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 50px; 
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            font-size: 20px;
            color: var(--primary-color);
            transition: var(--transition);
        }
        #toggle-controls-btn {
            top: 70px;
            left: 10px;
        }
        #toggle-info-btn {
            top: 130px;
            left: 10px;
        }
        #toggle-controls-btn:hover, #toggle-info-btn:hover {
            background-color: var(--light-gray);
            color: var(--primary-dark);
            transform: scale(1.1);
        }

        .close-panel-btn {
            position: absolute;
            top: 5px;
            left: 5px;
            background: none;
            border: none;
            font-size: 18px;
            color: var(--dark-gray);
            cursor: pointer;
            padding: 5px;
            line-height: 1;
            transition: var(--transition);
        }
        .close-panel-btn:hover {
            color: var(--primary-color);
        }

        h3 { 
            color: var(--primary-color); 
            font-size: 16px;
            margin: 0 0 10px 0; 
            text-align: center; 
            border-bottom: 1px solid var(--medium-gray);
            padding-bottom: 8px;
            font-weight: 600;
        }
        label { 
            display: block; 
            margin-bottom: 6px; 
            font-weight: 500; 
            color: var(--text-color);
            font-size: 13px;
            text-align: right;
        }

        input[type='text'], input[type='date'], input[type='password'], select { 
            width: 100%;
            padding: 8px 12px; 
            margin-bottom: 10px; 
            border-radius: 6px; 
            border: 1px solid var(--medium-gray); 
            box-sizing: border-box; 
            font-size: 13px;
            text-align: right;
            transition: var(--transition);
        }
        input[type='text']:focus, input[type='date']:focus, input[type='password']:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
        }
        input[type='checkbox'] { 
            margin-right: 5px; 
            vertical-align: middle;
            cursor: pointer;
        }

        button { 
            background-color: var(--primary-color); 
            color: white; 
            border: none; 
            padding: 8px 12px;
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 13px;
            margin-bottom: 8px; 
            width: 100%; 
            display: flex; 
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            transition: var(--transition);
            font-weight: 500;
        }
        button i { 
            margin-left: 8px; 
            font-size: 16px;
        } 
        button:hover { 
            background-color: var(--primary-dark); 
            box-shadow: var(--shadow); 
        }
        
        .print-btn { background-color: #337ab7; }
        .print-btn:hover { background-color: #286090; }
        .export-btn { background-color: var(--success-color); }
        .export-btn:hover { background-color: var(--primary-dark); }
        .alert-btn { background-color: var(--danger-color); }
        .alert-btn.active { background-color: var(--success-color); }
        .alert-btn.active:hover { background-color: var(--primary-dark); }
        
        .color-box {
            display: inline-block;
            width: 16px; 
            height: 16px;
            border: 1px solid var(--medium-gray);
            margin-left: 8px; 
            vertical-align: middle;
            border-radius: 4px;
        }

        .filter-section {
            border: 1px solid var(--medium-gray);
            padding: 8px 12px;
            margin-bottom: 12px;
            border-radius: 8px;
            background-color: var(--light-gray);
            transition: var(--transition);
        }
        .filter-section:hover {
            border-color: var(--primary-color);
        }
        .filter-section h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: var(--primary-color);
            text-align: center;
            font-weight: 500;
        }
        .filter-section label {
            margin-bottom: 4px;
            font-weight: normal;
            font-size: 13px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            line-height: 1.5;
            padding: 3px 0;
            cursor: pointer;
        }
        .filter-section label input[type='checkbox'] {
            order: 2;
            margin-right: 0;
            margin-left: 8px;
        }
        .filter-section label .color-box {
            order: 1;
            margin-left: 8px;
            margin-right: 0;
        }
        .filter-count {
            font-weight: bold;
            color: var(--primary-color);
            margin-right: 5px;
        }

        .info-item {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed var(--medium-gray);
        }
        .info-label {
            font-weight: 600;
            color: var(--primary-color);
            display: inline-block;
            min-width: 100px;
        }
        .info-value {
            color: var(--text-color);
        }
        .info-value.empty {
            color: var(--dark-gray);
            font-style: italic;
        }

        .social-buttons {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            gap: 10px;
        }
        .social-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            font-size: 24px;
            transition: var(--transition);
        }
        .social-btn:hover {
            transform: scale(1.1);
        }
        .whatsapp-btn { color: #25D366; }
        .email-btn { color: #0072C6; }
        .direction-btn { color: var(--primary-color); }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            text-align: center;
        }
        .modal-content h3 {
            margin-top: 0;
            color: var(--primary-color);
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-buttons button {
            width: auto;
            padding: 8px 16px;
        }
        .cancel-btn {
            background-color: var(--dark-gray);
        }
        .cancel-btn:hover {
            background-color: #616161;
        }

        .stats-container {
            background-color: var(--light-gray);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--medium-gray);
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 13px;
        }
        .stat-value {
            font-weight: bold;
            color: var(--primary-color);
        }

        @media (max-width: 768px) {
            #controls, #info { 
                width: 250px;
                font-size: 13px;
            }
        }
        @media (max-width: 480px) {
            #controls, #info { 
                width: 220px;
                font-size: 12px;
            }
        }

        .lang-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background-color: white;
            padding: 5px 10px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            display: flex;
            gap: 5px;
        }
        .lang-btn {
            background: none;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: var(--transition);
        }
        .lang-btn.active {
            background-color: var(--primary-color);
            color: white;
        }
    </style>
    <script src='https://unpkg.com/leaflet@1.7.1/dist/leaflet.js'></script>
    <script src='https://code.jquery.com/jquery-3.6.0.min.js'></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
<div id='map'></div>
<img id="logo" src='https://zmohd1987.github.io/map1/ShjLogo.png' alt='Ø´Ø¹Ø§Ø± Ø¨Ù„Ø¯ÙŠØ© Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø´Ø§Ø±Ù‚Ø©'>
 
<button id="toggle-controls-btn"><i class="fas fa-bars"></i></button>
<button id="toggle-info-btn"><i class="fas fa-info-circle"></i></button>

<div class="lang-toggle">
    <button class="lang-btn active" onclick="setLanguage('ar')">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
    <button class="lang-btn" onclick="setLanguage('en')">English</button>
</div>

<div id='controls' class='panel-hidden'>
    <h3 data-lang="ar">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
    <h3 data-lang="en" class="hidden">Control Panel</h3>
    
    <div class="stats-container">
        <div class="stat-item">
            <span data-lang="ar">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†Ø´Ø¢Øª:</span>
            <span data-lang="en" class="hidden">Total Facilities:</span>
            <span id="total-facilities" class="stat-value">0</span>
        </div>
        <div class="stat-item">
            <span data-lang="ar">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª:</span>
            <span data-lang="en" class="hidden">Total Actions:</span>
            <span id="total-actions" class="stat-value">0</span>
        </div>
        <div class="stat-item">
            <span data-lang="ar">Ø§Ù„Ù…Ù†Ø´Ø¢Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©:</span>
            <span data-lang="en" class="hidden">Displayed Facilities:</span>
            <span id="displayed-facilities" class="stat-value">0</span>
        </div>
    </div>
    
    <input type='text' id='search-lic' placeholder='Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ø®ØµØ©' data-lang-ar='Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ø®ØµØ©' data-lang-en='Search by name or license'>
    
    <button onclick="toggleVisibility('action-filters')">
        <i class='fas fa-filter'></i> 
        <span data-lang="ar">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</span>
        <span data-lang="en" class="hidden">Action</span>
    </button>
    <div id='action-filters' class='filter-section hidden'></div>
    
    <button onclick="toggleVisibility('sector-filters')">
        <i class='fas fa-layer-group'></i> 
        <span data-lang="ar">Ø§Ù„Ù‚Ø·Ø§Ø¹</span>
        <span data-lang="en" class="hidden">Sector</span>
    </button>
    <div id='sector-filters' class='filter-section hidden'></div>

    <button onclick="toggleVisibility('hazard-class-filters')">
        <i class='fas fa-exclamation-triangle'></i> 
        <span data-lang="ar">ÙØ¦Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø©</span>
        <span data-lang="en" class="hidden">Hazard Class</span>
    </button>
    <div id='hazard-class-filters' class='filter-section hidden'></div>
    
    <button onclick="toggleVisibility('area-filters')">
        <i class='fas fa-map-marker-alt'></i> 
        <span data-lang="ar">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</span>
        <span data-lang="en" class="hidden">Area</span>
    </button>
    <div id='area-filters' class='filter-section hidden'></div>
    
    <button onclick="toggleVisibility('activity-filters')">
        <i class='fas fa-utensils'></i> 
        <span data-lang="ar">Ø§Ù„Ù†Ø´Ø§Ø·</span>
        <span data-lang="en" class="hidden">Activity</span>
    </button>
    <div id='activity-filters' class='filter-section hidden'></div>
    
    <button onclick="toggleVisibility('certificate-filters')">
        <i class='fas fa-certificate'></i> 
        <span data-lang="ar">Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª</span>
        <span data-lang="en" class="hidden">Practice Certificate</span>
    </button>
    <div id='certificate-filters' class='filter-section hidden'></div>
    
    <button onclick="toggleVisibility('status-filters')">
        <i class='fas fa-info-circle'></i> 
        <span data-lang="ar">Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹</span>
        <span data-lang="en" class="hidden">Facility Status</span>
    </button>
    <div id='status-filters' class='filter-section hidden'></div>
    
    <button onclick='filterPoints()'>
        <i class='fas fa-check'></i> 
        <span data-lang="ar">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</span>
        <span data-lang="en" class="hidden">Apply Filters</span>
    </button>
    
    <button id="print-btn" class="print-btn" onclick="showPasswordModal('print')">
        <i class="fas fa-print"></i> 
        <span data-lang="ar">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</span>
        <span data-lang="en" class="hidden">Print Report</span>
    </button>
    
    <button id="export-excel-btn" class="export-btn" onclick="showPasswordModal('export')">
        <i class="fas fa-file-excel"></i> 
        <span data-lang="ar">ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</span>
        <span data-lang="en" class="hidden">Export to Excel</span>
    </button>
    
    <div id="modeSelector">
        <label data-lang="ar">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ¶Ø¹:</label>
        <label data-lang="en" class="hidden">Select Mode:</label>
        <select id="mode">
            <option value="walk" data-lang="ar">ğŸš¶â€â™‚ï¸ Ù…Ø´ÙŠ</option>
            <option value="walk" data-lang="en" class="hidden">ğŸš¶â€â™‚ï¸ Walk</option>
            <option value="car" data-lang="ar">ğŸš— Ø³ÙŠØ§Ø±Ø©</option>
            <option value="car" data-lang="en" class="hidden">ğŸš— Car</option>
        </select>
    </div>
    
    <hr style="margin: 10px 0; border-color: var(--medium-gray);">
    
    <label data-lang="ar">Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
    <label data-lang="en" class="hidden">From Date:</label>
    <input type='date' id='date-from'>
    
    <label data-lang="ar">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
    <label data-lang="en" class="hidden">To Date:</label>
    <input type='date' id='date-to'>
</div>

<div id='info' class='panel-hidden'>
    <button class="close-panel-btn" onclick="togglePanel('info')"><i class="fas fa-times"></i></button>
    <h3 data-lang="ar">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ù‚Ø·Ø©</h3>
    <h3 data-lang="en" class="hidden">Point Information</h3>
    
    <div class="info-item">
        <span class="info-label" data-lang="ar">Ø§Ù„Ø§Ø³Ù…:</span>
        <span class="info-label" data-lang="en" class="hidden">Name:</span>
        <span id='info-name' class="info-value empty">ØºÙŠØ± Ù…ØªÙˆÙØ±</span>
    </div>
    
    <div class="info-item">
        <span class="info-label" data-lang="ar">Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©:</span>
        <span class="info-label" data-lang="en" class="hidden">Brand:</span>
        <span id='info-BrandName' class="info-value empty">ØºÙŠØ± Ù…ØªÙˆÙØ±</span>
    </div>
    
    <div class="info-item">
        <span class="info-label" data-lang="ar">Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©:</span>
        <span class="info-label" data-lang="en" class="hidden">License No:</span>
        <span id='info-lic' class="info-value empty">ØºÙŠØ± Ù…ØªÙˆÙØ±</span>
    </div>
    
    <div class="info-item">
        <span class="info-label" data-lang="ar">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</span>
        <span class="info-label" data-lang="en" class="hidden">Area:</span>
        <span id='info-area' class="info-value empty">ØºÙŠØ± Ù…ØªÙˆÙØ±</span>
    </div>
    
    <div class="info-item">
        <span class="info-label" data-lang="ar">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©:</span>
        <span class="info-label" data-lang="en" class="hidden">Sub Area:</span>
        <span id='info-subarea' class="info-value empty">ØºÙŠØ± Ù…ØªÙˆÙØ±</span>
    </div>
    
    <div class="info-item">
        <span class="info-label" data-lang="ar">Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ:</span>
        <span class="info-label" data-lang="en" class="hidden">Sector:</span>
        <span id='info-sector' class="info-value empty">ØºÙŠØ± Ù…ØªÙˆÙØ±</span>
    </div>
    
    <div class="info-item">
        <span class="info-label" data-lang="ar">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ:</span>
        <span class="info-label" data-lang="en" class="hidden">Location:</span>
        <span id='info-AREA2' class="info-value empty">ØºÙŠØ± Ù…ØªÙˆÙØ±</span>
    </div>
    
    <div class="info-item">
        <span class="info-label" data-lang="ar">Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©:</span>
        <span class="info-label" data-lang="en" class="hidden">Sub Unit:</span>
        <span id='info-subunit' class="info-value empty">ØºÙŠØ± Ù…ØªÙˆÙØ±</span>
    </div>
    
    <div class="info-item">
        <span class="info-label" data-lang="ar">Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø´Ø£Ø©:</span>
        <span class="info-label" data-lang="en" class="hidden">Status:</span>
        <span id='info-FacilityStatus' class="info-value empty">ØºÙŠØ± Ù…ØªÙˆÙØ±</span>
    </div>
    
    <div class="info-item">
        <span class="info-label" data-lang="ar">Ø§Ù„Ù†Ø´Ø§Ø·:</span>
        <span class="info-label" data-lang="en" class="hidden">Activity:</span>
        <span id='info-Activity' class="info-value empty">ØºÙŠØ± Ù…ØªÙˆÙØ±</span>
    </div>
    
    <div class="info-item">
        <span class="info-label" data-lang="ar">ÙØ¦Ø© Ø§Ù„Ø®Ø·Ø±:</span>
        <span class="info-label" data-lang="en" class="hidden">Hazard Class:</span>
        <span id='info-HazardClass' class="info-value empty">ØºÙŠØ± Ù…ØªÙˆÙØ±</span>
    </div>
    
    <div class="info-item">
        <span class="info-label" data-lang="ar">Ø´Ù‡Ø§Ø¯Ù‡ Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª:</span>
        <span class="info-label" data-lang="en" class="hidden">Certificate:</span>
        <span id='info-SHJFSP' class="info-value empty">ØºÙŠØ± Ù…ØªÙˆÙØ±</span>
    </div>
    
    <div class="info-item">
        <span class="info-label" data-lang="ar">Ø§Ù„Ù…Ø¨Ù†Ù‰:</span>
        <span class="info-label" data-lang="en" class="hidden">Building:</span>
        <span id='info-Building' class="info-value empty">ØºÙŠØ± Ù…ØªÙˆÙØ±</span>
    </div>
    
    <div class="info-item">
        <span class="info-label" data-lang="ar">ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©:</span>
        <span class="info-label" data-lang="en" class="hidden">Last Visit:</span>
        <span id='info-Fdate' class="info-value empty">ØºÙŠØ± Ù…ØªÙˆÙØ±</span>
    </div>
    
    <div class="info-item">
        <span class="info-label" data-lang="ar">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡:</span>
        <span class="info-label" data-lang="en" class="hidden">Action:</span>
        <span id='info-action' class="info-value empty">ØºÙŠØ± Ù…ØªÙˆÙØ±</span>
    </div>
    
    <div class="info-item">
        <span class="info-label" data-lang="ar">Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª:</span>
        <span class="info-label" data-lang="en" class="hidden">Coordinates:</span>
        <span id='info-coordinates' class="info-value empty">ØºÙŠØ± Ù…ØªÙˆÙØ±</span>
    </div>

    <div class="social-buttons">
        <button class="social-btn whatsapp-btn" onclick="sendWhatsApp()">
            <i class="fab fa-whatsapp"></i>
        </button>
        <button class="social-btn email-btn" onclick="sendEmail()">
            <i class="fas fa-envelope"></i>
        </button>
        <button class="social-btn direction-btn" onclick="openDirections()">
            <i class="fas fa-directions"></i>
        </button>
    </div>
</div>

<div id="passwordModal" class="modal">
    <div class="modal-content">
        <h3 data-lang="ar">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
        <h3 data-lang="en" class="hidden">Enter Password</h3>
        <input type="password" id="passwordInput" placeholder="Password" data-lang-ar="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" data-lang-en="Password">
        <div class="modal-buttons">
            <button class="cancel-btn" onclick="closeModal()">
                <span data-lang="ar">Ø¥Ù„ØºØ§Ø¡</span>
                <span data-lang="en" class="hidden">Cancel</span>
            </button>
            <button id="confirmActionBtn" onclick="confirmAction()">
                <span data-lang="ar">ØªØ£ÙƒÙŠØ¯</span>
                <span data-lang="en" class="hidden">Confirm</span>
            </button>
        </div>
    </div>
</div>

<script>
// System variables
const map = L.map('map').setView([25.309479531503303, 55.45543330648655], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);
const allPointsLayer = L.layerGroup().addTo(map);
const pointsData = [];
let currentMode = 'car';
let alertsEnabled = false;
let alertInterval;
const notified = new Set();
let geolocationPermissionGranted = false;
let currentLanguage = 'ar';
let currentAction = '';


// You must replace this sample data with your full dataset.
        pointsData.push({latitude: 25.434907, longitude: 55.583596, AREA2: '', sector: 8, color: 'cyan', lightColor: 'lightcyan', sectorColor: 'indigo', fname: 'ÙƒØ±Ø§ÙƒØ± & Ø¨Ø§ÙƒØ± Ø´ Ù… Ø­', area: 'Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø­Ø±Ø© Ø¨Ø§Ù„Ø­Ù…Ø±ÙŠØ©', subarea: '', BrandName: '', FacilityStatus: 'Ù†Ø´Ø·', lic: '16198', subunit: 'Ù…ØµØ§Ù†Ø¹ Ø§Ù„Ø§ØºØ°ÙŠØ©', Fdate: '03/04/2025', action: '', Activity: 'ØµÙ†Ø§Ø¹Ø© Ø§Ù„Ø­Ù„ÙˆÙŠØ§Øª', HazardClass: 'Low', SHJFSP: 'HACCP', Building: ''});
        pointsData.push({latitude: 25.344285863825192, longitude: 55.39719152474706, AREA2: 'Ù…Ø­Ù„ Ø±Ù‚Ù… 3', sector: 2, color: 'green', lightColor: 'darkgreen', sectorColor: 'darkorange', fname: 'Ø§Ù„Ù†Ø¬Ø§Ø± Ù„ØªØ¬Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ùƒ Ø§Ù„Ù…Ù…Ù„Ø­Ø© Ø´ Ø° Ù… Ù… - ÙØ±Ø¹ Ø§Ù„Ø´Ø§Ø±Ù‚Ø©', area: 'Ø¨ÙˆØ¯Ø§Ù†Ù‚', subarea: '', BrandName: '', FacilityStatus: 'ØªØ¹Ù‡Ø¯ Ø¹Ø¯Ù… Ù…Ù…Ø§Ø±Ø³Ø© Ø§Ù„Ù†Ø´Ø§Ø·', lic: '767553', subunit: '', Fdate: '12/01/2025', action: 'Ù…Ù†Ø§Ø³Ø¨', Activity: 'Ø¨ÙŠØ¹ Ø§Ù„Ø£Ø³Ù…Ø§Ùƒ Ùˆ Ø§Ù„Ø£ØºØ°ÙŠØ© Ø§Ù„Ø¨Ø­Ø±ÙŠØ© Ø§Ù„Ù…Ù…Ù„Ø­Ø© Ùˆ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© - Ø¨Ø§Ù„ØªØ¬Ø²Ø¦Ø©', HazardClass: 'Medium', SHJFSP: '', Building: ''});
        pointsData.push({latitude: 25.347119429556994, longitude: 55.40348992938506, AREA2: 'Ù…Ø­Ù„ Ø±Ù‚Ù… 5 + 6', sector: 2, color: 'cyan', lightColor: 'lightcyan', sectorColor: 'darkorange', fname: 'ÙƒØ§ÙØªÙŠØ±ÙŠØ§ Ø¹ÙŠÙˆÙ† Ø§Ù„Ø³Ù„Ø³Ø¨ÙŠÙ„', area: 'Ø§Ù„ÙŠØ±Ù…ÙˆÙƒ', subarea: '', BrandName: '', FacilityStatus: 'ØªØ¹Ù‡Ø¯ Ø¹Ø¯Ù… Ù…Ù…Ø§Ø±Ø³Ø© Ø§Ù„Ù†Ø´Ø§Ø·', lic: '773052', subunit: '', Fdate: '25/12/2024', action: '', Activity: 'ÙƒØ§ÙØªÙŠØ±ÙŠØ§', HazardClass: 'high', SHJFSP: '', Building: ''});
        pointsData.push({latitude: 25.30548681794288, longitude: 55.36773492939049, AREA2: '', sector: 1, color: 'cyan', lightColor: 'lightcyan', sectorColor: 'darkblue', fname: 'Ø¨Ù‚Ø§Ù„Ø© Ø§Ù„Ù…ÙŠØ§Ø© Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡', area: 'Ø§Ù„Ù…Ù…Ø²Ø±', subarea: '', BrandName: '', FacilityStatus: 'ØªØ¹Ù‡Ø¯ Ø¹Ø¯Ù… Ù…Ù…Ø§Ø±Ø³Ø© Ø§Ù„Ù†Ø´Ø§Ø·', lic: '779585', subunit: '', Fdate: '', action: '', Activity: 'Ø¨Ù‚Ø§Ù„Ø©', HazardClass: 'Low', SHJFSP: '', Building: ''});
        pointsData.push({latitude: 25.312743998054305, longitude: 55.47685571404563, AREA2: '', sector: 7, color: 'cyan', lightColor: 'lightcyan', sectorColor: 'firebrick', fname: 'Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª Ø§ÙˆÙˆÙ„ Ø¯ÙŠ Ù…Ø§Ø±ÙƒØª Ø´ Ø° Ù… Ù… ÙØ±Ø¹ 1', area: 'Ø§Ù„Ø¬Ø§Ø¯Ø©', subarea: '', BrandName: '', FacilityStatus: 'ØªØ¹Ù‡Ø¯ Ø¹Ø¯Ù… Ù…Ù…Ø§Ø±Ø³Ø© Ø§Ù„Ù†Ø´Ø§Ø·', lic: '906053', subunit: '', Fdate: '', action: '', Activity: 'Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª', HazardClass: 'Low', SHJFSP: '', Building: ''});
        pointsData.push({latitude: 25.307753209173377, longitude: 55.45870510280212, AREA2: '', sector: 2, color: 'cyan', lightColor: 'lightcyan', sectorColor: 'darkorange', fname: 'Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª Ø­Ø³Ù†Ø© Ù…Ø­Ù…Ø¯ Ø° Ù… Ù… Ø´ Ø´ Ùˆ', area: 'ØªØ¬Ø§Ø±ÙŠØ© Ù…ÙˆÙŠÙ„Ø­', subarea: 'Ù…ÙˆÙŠÙ„Ø­ - Ù†Ø§Ø¯ÙŠ Ø§Ù„Ø«Ù‚Ø©', BrandName: '', FacilityStatus: 'Ù†Ø´Ø·', lic: '914178', subunit: '', Fdate: '', action: '', Activity: 'Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª', HazardClass: 'Low', SHJFSP: '', Building: ''});
function getActionColor(action) {
    switch (action) {
        case 'Ù…Ù†Ø§Ø³Ø¨': return '#28A745';
        case 'Ù…Ø®Ø§Ù„ÙØ©': return '#DC3545';
        case 'Ø§Ù†Ø°Ø§Ø±': return '#FFC107';
        case 'Ù…ØªØ§Ø¨Ø¹Ø©': return '#17A2B8';
        case 'Ù…ØµØ§Ø¯Ø±Ø©': return '#6C757D';
        case 'ØªØ­ÙØ¸': return '#6610F2';
        case 'ØªÙ‚Ø±ÙŠØ±': return '#007BFF';
        default: return '#808080';
    }
}

function getSectorColor(sector) {
    const colors = [
        '#E6194B', '#3CB44B', '#FFE119', '#4363D8', '#F58231', 
        '#911EB4', '#46F0F0', '#F032E6', '#BCF60C', '#FABEBE', 
        '#008080', '#AA6E28', '#800000', '#A9A9A9', '#000080' 
    ];
    return colors[(parseInt(sector) - 1) % colors.length];
}

function setLanguage(lang) {
    currentLanguage = lang;
    $('.lang-btn').removeClass('active');
    $(`.lang-btn[onclick="setLanguage('${lang}')"]`).addClass('active');
    
    $(`[data-lang="ar"]`).toggleClass('hidden', lang !== 'ar');
    $(`[data-lang="en"]`).toggleClass('hidden', lang !== 'en');
    
    $('#search-lic').attr('placeholder', $('#search-lic').attr(`data-lang-${lang}`));
    $('#passwordInput').attr('placeholder', $('#passwordInput').attr(`data-lang-${lang}`));
    
    populateFilters();
    updateStats();
}

function updateStats() {
    // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†Ø´Ø¢Øª
    $('#total-facilities').text(pointsData.length);
    
    // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª (ØªØ­Ø³Ø¨ ÙƒÙ„ Ø¥Ø¬Ø±Ø§Ø¡ Ù…Ù†ÙØµÙ„ ÙÙŠ Ø§Ù„Ù†Ù‚Ø·Ø©)
    let totalActions = 0;
    pointsData.forEach(point => {
        if (point.action) {
            const actions = point.action.split(/\+|\+/);
            totalActions += actions.length;
        }
    });
    $('#total-actions').text(totalActions);
    
    // Ø§Ù„Ù…Ù†Ø´Ø¢Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© Ø­Ø§Ù„ÙŠØ§Ù‹
    let displayedCount = 0;
    allPointsLayer.eachLayer(() => displayedCount++);
    $('#displayed-facilities').text(displayedCount);
}

function populateFilters() {
    // Get current filtered points
    const filteredPoints = getFilteredPoints();
    
    // Action filters
    updateFilterSection('action-filters', filteredPoints, 'action', 'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡', 'Action', (value) => {
        switch(value) {
            case 'Ù…Ù†Ø§Ø³Ø¨': return currentLanguage === 'ar' ? 'Ù…Ù†Ø§Ø³Ø¨' : 'Suitable';
            case 'Ù…Ø®Ø§Ù„ÙØ©': return currentLanguage === 'ar' ? 'Ù…Ø®Ø§Ù„ÙØ©' : 'Violation';
            case 'Ø§Ù†Ø°Ø§Ø±': return currentLanguage === 'ar' ? 'Ø§Ù†Ø°Ø§Ø±' : 'Warning';
            case 'Ù…ØªØ§Ø¨Ø¹Ø©': return currentLanguage === 'ar' ? 'Ù…ØªØ§Ø¨Ø¹Ø©' : 'Follow-up';
            case 'Ù…ØµØ§Ø¯Ø±Ø©': return currentLanguage === 'ar' ? 'Ù…ØµØ§Ø¯Ø±Ø©' : 'Confiscation';
            case 'ØªØ­ÙØ¸': return currentLanguage === 'ar' ? 'ØªØ­ÙØ¸' : 'Reservation';
            case 'ØªÙ‚Ø±ÙŠØ±': return currentLanguage === 'ar' ? 'ØªÙ‚Ø±ÙŠØ±' : 'Report';
            default: return value;
        }
    }, true);
    
    // Sector filters
    updateFilterSection('sector-filters', filteredPoints, 'sector', 'Ø§Ù„Ù‚Ø·Ø§Ø¹', 'Sector', (value) => {
        if (value === 7) return currentLanguage === 'ar' ? 'Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªØ³ÙˆÙ‚ 7' : 'Shopping Centers 7';
        if (value === 8) return currentLanguage === 'ar' ? 'Ø§Ù„Ù…Ù†Ø´Ø¢Øª Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ© 8' : 'Industrial Facilities 8';
        if (value === 9) return currentLanguage === 'ar' ? 'Ø±Ø®ØµØ© Ø§Ø¹ØªÙ…Ø§Ø¯ 9' : 'Accreditation License 9';
        if (value === 10) return currentLanguage === 'ar' ? 'Ø§Ù„Ù…Ù‚Ø§ØµÙ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ© 10' : 'School Canteens 10';
        if (value === 11) return currentLanguage === 'ar' ? 'Ø§Ù„Ù…Ø²Ø§Ø±Ø¹ 11' : 'Farms 11';
        return currentLanguage === 'ar' ? `Ø§Ù„Ù‚Ø·Ø§Ø¹ ${value}` : `Sector ${value}`;
    }, true);
    
    // Hazard class filters - Ø¨Ø¯ÙˆÙ† ØªØ±Ø¬Ù…Ø©
    updateFilterSection('hazard-class-filters', filteredPoints, 'HazardClass', 'ÙØ¦Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø©', 'Hazard Class', (value) => {
        return value; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚ÙŠÙ…Ø© ÙƒÙ…Ø§ Ù‡ÙŠ Ø¨Ø¯ÙˆÙ† ØªØ±Ø¬Ù…Ø©
    });
    
    // Area filters
    updateFilterSection('area-filters', filteredPoints, 'area', 'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©', 'Area');
    
    // Activity filters
    updateFilterSection('activity-filters', filteredPoints, 'Activity', 'Ø§Ù„Ù†Ø´Ø§Ø·', 'Activity');
    
    // Certificate filters
    updateFilterSection('certificate-filters', filteredPoints, 'SHJFSP', 'Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª', 'Practice Certificate');
    
    // Status filters
    updateFilterSection('status-filters', filteredPoints, 'FacilityStatus', 'Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'Facility Status', (value) => {
        if (value === 'Ù†Ø´Ø·') return currentLanguage === 'ar' ? 'Ù†Ø´Ø·' : 'Active';
        if (value === 'ØªØ¹Ù‡Ø¯ Ø¹Ø¯Ù… Ù…Ù…Ø§Ø±Ø³Ø© Ø§Ù„Ù†Ø´Ø§Ø·') return currentLanguage === 'ar' ? 'ØªØ¹Ù‡Ø¯ Ø¹Ø¯Ù… Ù…Ù…Ø§Ø±Ø³Ø© Ø§Ù„Ù†Ø´Ø§Ø·' : 'Non-activity Pledge';
        return value;
    });
}

function updateFilterSection(sectionId, points, field, arTitle, enTitle, formatValue = null, showColor = false) {
    const section = document.getElementById(sectionId);
    const counts = points.reduce((acc, point) => {
        acc[point[field]] = (acc[point[field]] || 0) + 1;
        return acc;
    }, {});
    
    // Define custom order for actions
    let orderedValues;
    if (field === 'action') {
        orderedValues = ['Ù…Ù†Ø§Ø³Ø¨', 'Ù…Ø®Ø§Ù„ÙØ©', 'Ø§Ù†Ø°Ø§Ø±', 'Ù…ØªØ§Ø¨Ø¹Ø©', 'Ù…ØµØ§Ø¯Ø±Ø©', 'ØªØ­ÙØ¸', 'ØªÙ‚Ø±ÙŠØ±'];
    } else {
        orderedValues = [...new Set(points.map(p => p[field]))].sort((a, b) => {
            if (typeof a === 'number' && typeof b === 'number') return a - b;
            return String(a).localeCompare(String(b));
        });
    }
    
    section.innerHTML = `
        <h4 data-lang="ar">${arTitle}</h4>
        <h4 data-lang="en" class="hidden">${enTitle}</h4>
    `;
    
    orderedValues.forEach(value => {
        if (!value) return;
        
        const count = counts[value] || 0;
        const displayValue = formatValue ? formatValue(value) : value;
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = `${field.replace(' ', '-')}-filter`;
        checkbox.value = value;
        checkbox.checked = true;
        
        label.appendChild(checkbox);
        
        if (showColor) {
            const colorBox = document.createElement('span');
            colorBox.className = 'color-box';
            if (field === 'action') {
                colorBox.style.backgroundColor = getActionColor(value);
            } else if (field === 'sector') {
                colorBox.style.backgroundColor = getSectorColor(value);
            }
            label.appendChild(colorBox);
        }
        
        label.innerHTML += ` <span class="filter-count">${count}</span> ${displayValue}`;
        section.appendChild(label);
    });
}

function getFilteredPoints() {
    const selectedActions = $('.action-filter:checked').map(function() { return $(this).val(); }).get();
    const selectedSectors = $('.sector-filter:checked').map(function() { return $(this).val(); }).get();
    const selectedHazardClasses = $('.HazardClass-filter:checked').map(function() { return $(this).val(); }).get();
    const selectedAreas = $('.area-filter:checked').map(function() { return $(this).val(); }).get();
    const selectedActivities = $('.Activity-filter:checked').map(function() { return $(this).val(); }).get();
    const selectedCertificates = $('.SHJFSP-filter:checked').map(function() { return $(this).val(); }).get();
    const selectedStatuses = $('.FacilityStatus-filter:checked').map(function() { return $(this).val(); }).get();
    
    const searchText = $('#search-lic').val().toLowerCase();
    const dateFromInput = $('#date-from').val();
    const dateToInput = $('#date-to').val();
    
    const dateFrom = dateFromInput ? new Date(dateFromInput) : null;
    const dateTo = dateToInput ? new Date(dateToInput) : null;
    
    if (dateTo) {
        dateTo.setHours(23, 59, 59, 999);
    }
    
    const isDateFilterActive = (dateFrom && dateTo && !isNaN(dateFrom.getTime()) && !isNaN(dateTo.getTime()));
    
    return pointsData.filter(function(point) {
        const actionMatch = selectedActions.length === 0 || selectedActions.some(action => point.action.includes(action));
        const sectorMatch = selectedSectors.length === 0 || selectedSectors.includes(String(point.sector));
        const hazardClassMatch = selectedHazardClasses.length === 0 || selectedHazardClasses.includes(point.HazardClass);
        const areaMatch = selectedAreas.length === 0 || selectedAreas.includes(point.area);
        const activityMatch = selectedActivities.length === 0 || selectedActivities.includes(point.Activity);
        const certificateMatch = selectedCertificates.length === 0 || selectedCertificates.includes(point.SHJFSP);
        const statusMatch = selectedStatuses.length === 0 || selectedStatuses.includes(point.FacilityStatus);

        const searchMatch = searchText === '' || 
            (point.lic && point.lic.toLowerCase().includes(searchText)) || 
            (point.fname && point.fname.toLowerCase().includes(searchText)) || 
            (point.BrandName && point.BrandName.toLowerCase().includes(searchText)) || 
            (point.area && point.area.toLowerCase().includes(searchText)) || 
            (point.subarea && point.subarea.toLowerCase().includes(searchText)) ||
            (point.subunit && point.subunit.toLowerCase().includes(searchText)) ||
            (point.FacilityStatus && point.FacilityStatus.toLowerCase().includes(searchText)) || 
            (point.Fdate && point.Fdate.includes(searchText)) ||
            (point.Activity && point.Activity.toLowerCase().includes(searchText)) ||
            (point.HazardClass && point.HazardClass.toLowerCase().includes(searchText)) ||
            (point.SHJFSP && point.SHJFSP.toLowerCase().includes(searchText)) ||
            (point.Building && point.Building.toLowerCase().includes(searchText));
        
        let dateMatch = true;
        if (isDateFilterActive && point.Fdate) {
            const dateParts = point.Fdate.split('/');
            if (dateParts.length === 3) {
                const pointDate = new Date(`${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`);
                pointDate.setHours(0, 0, 0, 0);
                dateMatch = pointDate >= dateFrom && pointDate <= dateTo;
            } else {
                dateMatch = false;
            }
        } else if (isDateFilterActive && !point.Fdate) {
            dateMatch = false;
        }
        
        return actionMatch && sectorMatch && hazardClassMatch && areaMatch && 
               activityMatch && certificateMatch && statusMatch && searchMatch && dateMatch;
    });
}

function toggleVisibility(id) {
    const element = document.getElementById(id);
    if (element) {
        element.classList.toggle('hidden');
    }
}

function togglePanel(panelId) {
    const panel = $(`#${panelId}`);
    panel.toggleClass('panel-hidden');
    if (panelId === 'info' && panel.hasClass('panel-hidden')) {
        clearInfoPanel();
    }
}

function clearInfoPanel() {
    $('.info-value').text(currentLanguage === 'ar' ? 'ØºÙŠØ± Ù…ØªÙˆÙØ±' : 'N/A').addClass('empty');
}

function showPasswordModal(action) {
    currentAction = action;
    $('#passwordModal').show();
    $('#passwordInput').focus();
}

function closeModal() {
    $('#passwordModal').hide();
    $('#passwordInput').val('');
}

function confirmAction() {
    const password = $('#passwordInput').val();
    if (password === 'kf2025') {
        closeModal();
        if (currentAction === 'print') {
            printReport();
        } else if (currentAction === 'export') {
            exportToExcel();
        }
    } else {
        alert(currentLanguage === 'ar' ? 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©' : 'Incorrect password');
    }
}

function filterPoints() {
    const filteredPoints = getFilteredPoints();
    renderPoints(filteredPoints);
    populateFilters(); // Update filter counts
    updateStats(); // Update statistics
}

function renderPoints(points) {
    allPointsLayer.clearLayers();
    points.forEach(function(point) {
        const actionColor = getActionColor(point.action.split(/\+|\+/)[0]); // Take first action for color
        const sectorStrokeColor = getSectorColor(point.sector);

        const pointMarker = L.circleMarker([point.latitude, point.longitude], {
            radius: 8,
            fillColor: actionColor,
            color: sectorStrokeColor, 
            weight: 2, 
            opacity: 1,
            fillOpacity: 0.9
        }).addTo(allPointsLayer);
        
        pointMarker.pointData = point;

        pointMarker.on('click', function() {
            $('#info').removeClass('panel-hidden');
            
            const updateInfoField = (id, value) => {
                const element = $(`#${id}`);
                if (value) {
                    element.text(value).removeClass('empty');
                } else {
                    element.text(currentLanguage === 'ar' ? 'ØºÙŠØ± Ù…ØªÙˆÙØ±' : 'N/A').addClass('empty');
                }
            };
            
            updateInfoField('info-name', point.fname);
            updateInfoField('info-BrandName', point.BrandName);
            updateInfoField('info-lic', point.lic);
            updateInfoField('info-area', point.area);
            updateInfoField('info-subarea', point.subarea);
            updateInfoField('info-sector', point.sector);
            updateInfoField('info-AREA2', point.AREA2);
            updateInfoField('info-subunit', point.subunit);
            updateInfoField('info-FacilityStatus', point.FacilityStatus);
            updateInfoField('info-Activity', point.Activity);
            updateInfoField('info-HazardClass', point.HazardClass);
            updateInfoField('info-SHJFSP', point.SHJFSP);
            updateInfoField('info-Building', point.Building);
            updateInfoField('info-Fdate', point.Fdate);
            updateInfoField('info-action', point.action);
            
            if (point.latitude && point.longitude) {
                $('#info-coordinates').text(`${point.latitude.toFixed(6)}, ${point.longitude.toFixed(6)}`).removeClass('empty');
            } else {
                $('#info-coordinates').text(currentLanguage === 'ar' ? 'ØºÙŠØ± Ù…ØªÙˆÙØ±' : 'N/A').addClass('empty');
            }
        });
        
        pointMarker.on('dblclick', function() {
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${point.latitude},${point.longitude}&travelmode=${currentMode}`, '_blank');
        });
    });
    
    updateStats();
}

function printReport() {
    const printWindow = window.open('', '_blank');
    printWindow.document.write('<html><head><title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø·</title>');
    printWindow.document.write('<style>');
    printWindow.document.write(`
        body { direction: rtl; font-family: 'Arial', sans-serif; margin: 20px; color: #333; }
        h1 { text-align: center; color: #388e3c; margin-bottom: 25px; } 
        img.print-logo { display: block; margin: 0 auto 20px auto; max-width: 150px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: auto; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: right; font-size: 9px; word-wrap: break-word; } 
        th { background-color: #f2f2f2; color: #333; font-weight: bold; }
        
        .action-warning-print { background-color: #FFC107 !important; color: black !important; }
        .action-violation-print { background-color: #DC3545 !important; color: white !important; }
        .action-samples-print { background-color: #17A2B8 !important; color: white !important; }
        .action-followup-print { background-color: #28A745 !important; color: white !important; }
        .action-closed-print { background-color: #6C757D !important; color: white !important; }
        .action-report-print { background-color: #007BFF !important; color: white !important; }
        .action-suitable-print { background-color: #28A745 !important; color: white !important; font-weight: bold; }
        .action-confiscation-print { background-color: #6C757D !important; color: white !important; }
        .action-reservation-print { background-color: #6610F2 !important; color: white !important; }

        .footer { text-align: left; font-size: 10px; margin-top: 30px; border-top: 1px solid #c8e6c9; padding-top: 10px; color: #555; }

        #map, #controls, #info, #logo, .toggle-panel-btn, .close-panel-btn { display: none !important; }
    `);
    printWindow.document.write('</style>');
    printWindow.document.write('</head><body>');

    printWindow.document.write('<img class="print-logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/55/Sharjah_emblem.svg/1200px-Sharjah_emblem.svg.png" alt="Ø´Ø¹Ø§Ø± Ø¨Ù„Ø¯ÙŠØ© Ø§Ù„Ø´Ø§Ø±Ù‚Ø©">');
    printWindow.document.write('<img class="print-logo" src="https://zmohd1987.github.io/map1/ShjLogo.png" alt="Ø´Ø¹Ø§Ø± Ø¨Ù„Ø¯ÙŠØ© Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø´Ø§Ø±Ù‚Ø©">');
    printWindow.document.write('<h1>ØªÙ‚Ø±ÙŠØ± Ù†Ù‚Ø§Ø· Ø¨Ù„Ø¯ÙŠØ© Ø§Ù„Ø´Ø§Ø±Ù‚Ø©</h1>');
    
    const pointsToPrint = [];
    allPointsLayer.eachLayer(function(layer) {
        if (layer.pointData) {
            pointsToPrint.push(layer.pointData);
        }
    });

    if (pointsToPrint.length === 0) {
        printWindow.document.write('<p style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ù‚Ø§Ø· Ù„Ø¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø·Ø¨Ù‚Ø©.</p>');
        printWindow.document.write('<p style="text-align:center;">Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‚Ø¯ Ø·Ø¨Ù‚Øª ÙÙ„Ø§ØªØ±ØŒ ÙÙ‡Ø°Ø§ ÙŠØ¹Ù†ÙŠ Ø£Ù†Ù‡ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ù‚Ø§Ø· ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>');
    } else {
        printWindow.document.write('<p style="text-align:center;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹: <strong>' + pointsToPrint.length + '</strong></p>');
        printWindow.document.write('<table><thead><tr>');
        printWindow.document.write('<th>Ø§Ù„Ø§Ø³Ù…</th>');
        printWindow.document.write('<th>Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</th>');
        printWindow.document.write('<th>Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©</th>');
        printWindow.document.write('<th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>');
        printWindow.document.write('<th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©</th>');
        printWindow.document.write('<th>Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ</th>');
        printWindow.document.write('<th>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</th>');
        printWindow.document.write('<th>Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©</th>');
        printWindow.document.write('<th>Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø´Ø£Ø©</th>');
        printWindow.document.write('<th>Ø§Ù„Ù†Ø´Ø§Ø·</th>');
        printWindow.document.write('<th>ÙØ¦Ø© Ø§Ù„Ø®Ø·Ø±</th>');
        printWindow.document.write('<th>Ø´Ù‡Ø§Ø¯Ù‡ Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª</th>');
        printWindow.document.write('<th>Ø§Ù„Ù…Ø¨Ù†Ù‰</th>');
        printWindow.document.write('<th>ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©</th>');
        printWindow.document.write('<th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>');
        printWindow.document.write('<th>Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª</th>');
        printWindow.document.write('</tr></thead><tbody>');
        
        pointsToPrint.forEach(function(point) {
            let actionClass = '';
            if (point.action === 'Ø§Ù†Ø°Ø§Ø±') actionClass = 'action-warning-print';
            else if (point.action === 'Ù…Ø®Ø§Ù„ÙØ©') actionClass = 'action-violation-print';
            else if (point.action === 'Ø¹ÙŠÙ†Ø§Øª') actionClass = 'action-samples-print';
            else if (point.action === 'Ù…ØªØ§Ø¨Ø¹Ø©') actionClass = 'action-followup-print';
            else if (point.action === 'Ù…ØºÙ„Ù‚') actionClass = 'action-closed-print';
            else if (point.action === 'ØªÙ‚Ø±ÙŠØ±') actionClass = 'action-report-print';
            else if (point.action === 'Ù…Ù†Ø§Ø³Ø¨') actionClass = 'action-suitable-print';
            else if (point.action === 'Ù…ØµØ§Ø¯Ø±Ø©') actionClass = 'action-confiscation-print';
            else if (point.action === 'ØªØ­ÙØ¸') actionClass = 'action-reservation-print';

            printWindow.document.write('<tr>');
            printWindow.document.write('<td>' + (point.fname || '') + '</td>');
            printWindow.document.write('<td>' + (point.BrandName || '') + '</td>');
            printWindow.document.write('<td>' + (point.lic || '') + '</td>');
            printWindow.document.write('<td>' + (point.area || '') + '</td>');
            printWindow.document.write('<td>' + (point.subarea || '') + '</td>');
            printWindow.document.write('<td>' + (point.sector || '') + '</td>');
            printWindow.document.write('<td>' + (point.AREA2 || '') + '</td>');
            printWindow.document.write('<td>' + (point.subunit || '') + '</td>');
            printWindow.document.write('<td>' + (point.FacilityStatus || '') + '</td>');
            printWindow.document.write('<td>' + (point.Activity || '') + '</td>');
            printWindow.document.write('<td>' + (point.HazardClass || '') + '</td>');
            printWindow.document.write('<td>' + (point.SHJFSP || '') + '</td>');
            printWindow.document.write('<td>' + (point.Building || '') + '</td>');
            printWindow.document.write('<td>' + (point.Fdate || '') + '</td>');
            printWindow.document.write('<td class="' + actionClass + '">' + (point.action || '') + '</td>');
            printWindow.document.write('<td>' + (point.latitude ? point.latitude.toFixed(6) + ', ' + point.longitude.toFixed(6) : '') + '</td>');
            printWindow.document.write('</tr>');
        });
        
        printWindow.document.write('</tbody></table>');
    }

    printWindow.document.write('<div class="footer">');
    printWindow.document.write('<p>ØªØ§Ø±ÙŠØ® Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ' + new Date().toLocaleString('ar-AE') + '</p>');
    printWindow.document.write('<p>Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù†Ø´Ø± Â© Ø¨Ù„Ø¯ÙŠØ© Ø§Ù„Ø´Ø§Ø±Ù‚Ø©</p>');
    printWindow.document.write('</div>');
    printWindow.document.close();
    printWindow.print();
}

function exportToExcel() {
    const pointsToExport = [];
    allPointsLayer.eachLayer(function(layer) {
        if (layer.pointData) {
            pointsToExport.push(layer.pointData);
        }
    });

    if (pointsToExport.length === 0) {
        alert(currentLanguage === 'ar' ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ù‚Ø§Ø· Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§." : "No points to export.");
        return;
    }

    const headers = [
        'fname', 'BrandName', 'lic', 'area', 'subarea', 'sector', 'AREA2', 'subunit', 
        'FacilityStatus', 'Activity', 'HazardClass', 'SHJFSP', 'Building', 'Fdate', 
        'action', 'latitude', 'longitude'
    ];
    const headerLabels = {
        'fname': currentLanguage === 'ar' ? 'Ø§Ù„Ø§Ø³Ù…' : 'Name',
        'BrandName': currentLanguage === 'ar' ? 'Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©' : 'Brand',
        'lic': currentLanguage === 'ar' ? 'Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©' : 'License No',
        'area': currentLanguage === 'ar' ? 'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©' : 'Area',
        'subarea': currentLanguage === 'ar' ? 'Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©' : 'Sub Area',
        'sector': currentLanguage === 'ar' ? 'Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ' : 'Sector',
        'AREA2': currentLanguage === 'ar' ? 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ' : 'Location',
        'subunit': currentLanguage === 'ar' ? 'Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©' : 'Sub Unit',
        'FacilityStatus': currentLanguage === 'ar' ? 'Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø´Ø£Ø©' : 'Status',
        'Activity': currentLanguage === 'ar' ? 'Ø§Ù„Ù†Ø´Ø§Ø·' : 'Activity',
        'HazardClass': currentLanguage === 'ar' ? 'ÙØ¦Ø© Ø§Ù„Ø®Ø·Ø±' : 'Hazard Class',
        'SHJFSP': currentLanguage === 'ar' ? 'Ø´Ù‡Ø§Ø¯Ù‡ Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª' : 'Certificate',
        'Building': currentLanguage === 'ar' ? 'Ø§Ù„Ù…Ø¨Ù†Ù‰' : 'Building',
        'Fdate': currentLanguage === 'ar' ? 'ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©' : 'Last Visit',
        'action': currentLanguage === 'ar' ? 'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡' : 'Action',
        'latitude': currentLanguage === 'ar' ? 'Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶' : 'Latitude',
        'longitude': currentLanguage === 'ar' ? 'Ø®Ø· Ø§Ù„Ø·ÙˆÙ„' : 'Longitude'
    };

    let csv = '\ufeff' + headers.map(header => `"${headerLabels[header] || header}"`).join(',') + '\n';

    pointsToExport.forEach(point => {
        const row = headers.map(header => {
            let value = point[header] || '';
            if (header === 'latitude' || header === 'longitude') {
                value = typeof value === 'number' ? value.toFixed(6) : value;
            }
            return `"${String(value).replace(/"/g, '""')}"`;
        }).join(',');
        csv += row + '\n';
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8-sig;' });
    const link = document.createElement('a');
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', currentLanguage === 'ar' ? 'ØªÙ‚Ø±ÙŠØ±_Ù†Ù‚Ø§Ø·_Ø¨Ù„Ø¯ÙŠØ©_Ø§Ù„Ø´Ø§Ø±Ù‚Ø©.csv' : 'Sharjah_Municipality_Points_Report.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } else {
        alert(currentLanguage === 'ar' ? "Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù…Ù„ÙØ§Øª CSV. ÙŠØ±Ø¬Ù‰ Ø­ÙØ¸ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠØ¯ÙˆÙŠÙ‹Ø§." : "Your browser doesn't support direct CSV export. Please save the content manually.");
    }
}

function sendWhatsApp() {
    const name = $('#info-name').text();
    const brandName = $('#info-BrandName').text();
    const lic = $('#info-lic').text();
    const area = $('#info-area').text();
    const subarea = $('#info-subarea').text();
    const sector = $('#info-sector').text();
    const AREA2 = $('#info-AREA2').text();
    const status = $('#info-FacilityStatus').text();
    const Fdate = $('#info-Fdate').text();
    const action = $('#info-action').text();
    const activity = $('#info-Activity').text();
    const hazardClass = $('#info-HazardClass').text();
    const SHJFSP = $('#info-SHJFSP').text();
    const building = $('#info-Building').text();
    const coordinatesText = $('#info-coordinates').text().trim();
    const [latitude, longitude] = coordinatesText.split(',').map(c => c.trim());
    
    const googleMapsLink = `https://www.google.com/maps/dir/?api=1&destination=${latitude},${longitude}&travelmode=${currentMode}`;
    
    let message = '';
    if (currentLanguage === 'ar') {
        message = `Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ù‚Ø·Ø©:
Ø§Ù„Ø§Ø³Ù…: ${name}
Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©: ${brandName}
Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©: ${lic}
Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${area}
Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©: ${subarea}
Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ: ${sector}
Ø§Ù„ÙˆØµÙ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ: ${AREA2}
Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø´Ø£Ø©: ${status}
Ø§Ù„Ù†Ø´Ø§Ø·: ${activity}
ÙØ¦Ø© Ø§Ù„Ø®Ø·Ø±: ${hazardClass}
Ø´Ù‡Ø§Ø¯Ù‡ Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª: ${SHJFSP}
Ø§Ù„Ù…Ø¨Ù†Ù‰: ${building}
ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©: ${Fdate}
Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡: ${action}
Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª: ${coordinatesText}
Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„: ${googleMapsLink}`;
    } else {
        message = `Point Information:
Name: ${name}
Brand: ${brandName}
License No: ${lic}
Area: ${area}
Sub Area: ${subarea}
Sector: ${sector}
Location: ${AREA2}
Status: ${status}
Activity: ${activity}
Hazard Class: ${hazardClass}
Certificate: ${SHJFSP}
Building: ${building}
Last Visit: ${Fdate}
Action: ${action}
Coordinates: ${coordinatesText}
Google Maps Link: ${googleMapsLink}`;
    }
    
    const whatsappURL = `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(whatsappURL, '_blank');
}

function sendEmail() {
    const name = $('#info-name').text();
    const brandName = $('#info-BrandName').text();
    const lic = $('#info-lic').text();
    const area = $('#info-area').text();
    const subarea = $('#info-subarea').text();
    const sector = $('#info-sector').text();
    const AREA2 = $('#info-AREA2').text();
    const status = $('#info-FacilityStatus').text();
    const action = $('#info-action').text();
    const Fdate = $('#info-Fdate').text();
    const activity = $('#info-Activity').text();
    const hazardClass = $('#info-HazardClass').text();
    const SHJFSP = $('#info-SHJFSP').text();
    const building = $('#info-Building').text();
    const coordinatesText = $('#info-coordinates').text().trim();
    const [latitude, longitude] = coordinatesText.split(',').map(c => c.trim());
    
    const googleMapsLink = `https://www.google.com/maps/dir/?api=1&destination=${latitude},${longitude}&travelmode=${currentMode}`;
    
    let subject = currentLanguage === 'ar' ? "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ù‚Ø·Ø©" : "Point Information";
    let body = '';
    
    if (currentLanguage === 'ar') {
        body = `Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ù‚Ø·Ø©:
Ø§Ù„Ø§Ø³Ù…: ${name}
Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©: ${brandName}
Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©: ${lic}
Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${area}
Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©: ${subarea}
Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ: ${sector}
Ø§Ù„ÙˆØµÙ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ: ${AREA2}
Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø´Ø£Ø©: ${status}
Ø§Ù„Ù†Ø´Ø§Ø·: ${activity}
ÙØ¦Ø© Ø§Ù„Ø®Ø·Ø±: ${hazardClass}
Ø´Ù‡Ø§Ø¯Ù‡ Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª: ${SHJFSP}
Ø§Ù„Ù…Ø¨Ù†Ù‰: ${building}
ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©: ${Fdate}
Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡: ${action}
Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª: ${coordinatesText}
Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„: ${googleMapsLink}`;
    } else {
        body = `Point Information:
Name: ${name}
Brand: ${brandName}
License No: ${lic}
Area: ${area}
Sub Area: ${subarea}
Sector: ${sector}
Location: ${AREA2}
Status: ${status}
Activity: ${activity}
Hazard Class: ${hazardClass}
Certificate: ${SHJFSP}
Building: ${building}
Last Visit: ${Fdate}
Action: ${action}
Coordinates: ${coordinatesText}
Google Maps Link: ${googleMapsLink}`;
    }
    
    const mailtoURL = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.open(mailtoURL, '_blank');
}

function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const Ï†1 = lat1 * Math.PI / 180;
    const Ï†2 = lat2 * Math.PI / 180;
    const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
    const Î”Î» = (lon2 - lon1) * Math.PI / 180;

    const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
              Math.cos(Ï†1) * Math.cos(Ï†2) *
              Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function getDrivingTimeInMinutes(distanceMeters) {
    const mode = document.getElementById("mode").value;
    let speedMetersPerMinute;

    if (mode === 'car') {
        const now = new Date();
        const hour = now.getHours();
        const minute = now.getMinutes();
        const currentTimeInMinutes = hour * 60 + minute;

        const isRushHour =
            (currentTimeInMinutes >= 7 * 60 && currentTimeInMinutes <= 10 * 60) ||     // Ù…Ù† 7:00 Ø¥Ù„Ù‰ 10:00 ØµØ¨Ø§Ø­Ù‹Ø§
            (currentTimeInMinutes >= 14.5 * 60 && currentTimeInMinutes <= 22 * 60);    // Ù…Ù† 2:30 Ø¥Ù„Ù‰ 10:00 Ù…Ø³Ø§Ø¡Ù‹

        // Ø§Ù„Ø³Ø±Ø¹Ø© Ø­Ø³Ø¨ Ø§Ù„Ø²Ø­Ø§Ù…
        speedMetersPerMinute = isRushHour ? 166.67 : 333.33;
    } else {
        speedMetersPerMinute = 83.33; // Ù…Ø´ÙŠ = 5 ÙƒÙ…/Ø³Ø§Ø¹Ø©
    }

    return distanceMeters / speedMetersPerMinute;
}

function checkNearbyWarnings() {
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(pos => {
        const userLat = pos.coords.latitude;
        const userLon = pos.coords.longitude;

        pointsData.forEach(point => {
            if (point.action === 'Ø§Ù†Ø°Ø§Ø±') {
                const distance = getDistance(userLat, userLon, point.latitude, point.longitude);
                const time = getDrivingTimeInMinutes(distance);
                if (time <= 10000 && !notified.has(point.fname)) {
                    const msg = `
ğŸ“ Ø§Ù„Ø§Ø³Ù…: ${point.fname}
ğŸ“ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${point.area}
ğŸ“„ Ø§Ù„Ø±Ø®ØµØ©: ${point.lic}
ğŸ¢ Ø§Ù„Ù‚Ø·Ø§Ø¹: ${point.sector}
ğŸ“… Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©: ${point.Fdate}
â³ Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù„Ù„ÙˆØµÙˆÙ„: ${Math.round(time)} Ø¯Ù‚ÙŠÙ‚Ø©
                    `;
                    const confirmReview = confirm(msg + "Ù‡Ù„ ØªØ±ØºØ¨ Ø¨Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¢Ù†ØŸ");
                    if (confirmReview) {
                        window.open(`https://www.google.com/maps/dir/?api=1&destination=${point.latitude},${point.longitude}`, '_blank');
                    }
                    notified.add(point.fname);
                }
            }
        });
    });
}

function openDirections() {
    const coordinatesText = $('#info-coordinates').text().trim();
    if (coordinatesText && coordinatesText !== 'ØºÙŠØ± Ù…ØªÙˆÙØ±' && coordinatesText !== 'N/A') {
        const [latitude, longitude] = coordinatesText.split(',').map(c => c.trim());
        window.open(`https://www.google.com/maps/dir/?api=1&destination=${latitude},${longitude}&travelmode=${currentMode}`, '_blank');
    } else {
        alert(currentLanguage === 'ar' ? 'Ù„Ø§ ØªØªÙˆÙØ± Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù†Ù‚Ø·Ø©' : 'No coordinates available for this point');
    }
}

// Initialize
$(document).ready(function() {
    // Populate filters with counts
    populateFilters();
    
    // Initial render
    filterPoints();
    
    // Set up event listeners
    $('#search-lic').on('input', filterPoints);
    $('#date-from').on('change', filterPoints);
    $('#date-to').on('change', filterPoints);
    
    $('#toggle-controls-btn').on('click', function() { togglePanel('controls'); });
    $('#toggle-info-btn').on('click', function() { togglePanel('info'); });

    // Mode change listener
    $('#mode').on('change', function() {
        currentMode = $(this).val();
        notified.clear();
        checkNearbyWarnings();
    });

    // Initially hide panels
    $('#controls').addClass('panel-hidden');
    $('#info').addClass('panel-hidden');
    
    // Check for nearby warnings every 30 seconds
    setInterval(checkNearbyWarnings, 30000);
    
    // Close modal when clicking outside
    window.onclick = function(event) {
        if (event.target == document.getElementById('passwordModal')) {
            closeModal();
        }
    }
});
</script>
</body>
